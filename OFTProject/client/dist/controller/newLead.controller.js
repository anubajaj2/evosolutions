sap.ui.define(["oft/fiori/controller/BaseController","sap/m/MessageBox","sap/m/MessageToast","oft/fiori/models/formatter","sap/ui/model/Filter"],function(e,t,a,o,r){"use strict";return e.extend("oft.fiori.controller.newLead",{formatter:o,onInit:function(){this.oRouter=sap.ui.core.UIComponent.getRouterFor(this);this.clearForm();e.prototype.onInit.apply(this);this.oRouter.attachRoutePatternMatched(this.herculis,this);var t=this.getModel("local").getProperty("/CurrentUser");if(t){var a=this.getModel("local").oData.AppUsers[t].UserName;this.getView().byId("idUser").setText(a)}},clearForm:function(){},onViewPhoto:function(e){var t=this.getView();var a=this;a.photoPath=e.getSource().getParent().getBindingContextPath();var o=this.getView().getModel("local").getProperty(a.photoPath+"/Photo");if(!a.oViewAndUploadPhoto){a.oViewAndUploadPhoto=sap.ui.core.Fragment.load({id:t.getId(),name:"oft.fiori.fragments.viewAndUploadPhoto",controller:this});a.oViewAndUploadPhoto.then(function(e){t.addDependent(e);e.getContent()[0].getItems()[0].getItems()[0].setSrc(o);e.open()})}else{a.oViewAndUploadPhoto.then(function(e){e.getContent()[0].getItems()[0].getItems()[0].setSrc(o);e.getContent()[0].getItems()[1].getItems()[0].clear();if(a.isLeadDetail&&o){e.getContent()[0].getItems()[1].getItems()[0].setEnabled(false)}else{e.getContent()[0].getItems()[1].getItems()[0].setEnabled(true)}e.open()})}},onUploadPhotoClose:function(){this.oViewAndUploadPhoto.then(function(e){e.getContent()[0].getItems()[1].getItems()[0].clear();e.close()})},onFileUploaderChange:function(e){var t=this;if(e.getParameter("files").length>0){var a=e.getParameter("files")[0];var o=e.getSource().getParent().getParent().getItems()[0].getItems()[0];var r=new FileReader;r.onload=function(e){o.setSrc(e.target.result);t.getView().getModel("local").setProperty(t.photoPath+"/Photo",e.target.result)};r.readAsDataURL(a)}},onClearForm:function(){this.getView().getModel("local").setProperty("/newLead",{EmailId:"",CourseName:" ",Category:" ",Date:new Date,FatherName:"",MotherName:"",City:"Gurgaon",Phone:"",EmailId2:"",Remarks:"",currency:"INR",Address:"",organization:"",custType:"",CreatedOn:"",CreatedBy:"",ChangedBy:"",ChangedOn:"",courseSet:"",HearAbout:"JustDial",EmergencyContactName:"",EmergencyContactNo:"",WardDetails:[]});this.flag=null},passwords:"",onEmail:function(){var e=this;var t=e.getView().byId("idRecent").getSelectedContexts();for(var a=0;a<t["length"];a++){var o=t[a].getModel().getProperty(t[a].getPath());if(this.passwords===""){this.passwords=prompt("Please enter your password","");if(this.passwords===""){sap.m.MessageBox.error("Blank Password not allowed");return}}o.password=this.passwords;o.DollerQuote=this.getView().byId("doller").getSelected();o.courseId=this.getView().byId("idCourse1").getSelectedKey();$.post("/sendInquiryEmail",o).done(function(e,t){sap.m.MessageToast.show("Email sent successfully")}).fail(function(t,a,o){e.passwords="";sap.m.MessageBox.error(t.responseText)})}},onDataExport:function(e){$.ajax({type:"GET",url:"InquiryDownload",success:function(e){sap.m.MessageToast.show("File Downloaded succesfully")},error:function(e,t,a){sap.m.MessageToast.show("error in downloading the excel file")}})},onDelete:function(e){var a=this;t.confirm("Do you want to delete the selected records?",function(e){if(e=="OK"){var t=a.getView().byId("idRecent").getSelectedContexts();for(var o=0;o<t["length"];o++){a.ODataHelper.callOData(a.getOwnerComponent().getModel(),t[o].sPath,"DELETE",{},{},a).then(function(e){sap.m.MessageToast.show("Deleted succesfully")}).catch(function(e){a.getView().setBusy(false);a.oPopover=a.getErrorMessage(e);a.getView().setBusy(false)})}}},"Confirmation")},onBack:function(){sap.ui.getCore().byId("idApp").to("idView1")},onItemSelect:function(e){var t=e.getParameter("listItem").getBindingContextPath();var a=t.split("/")[t.split("/").length-1];this.oRouter.navTo("detail2",{suppId:a})},onPress:function(){sap.m.MessageBox.alert("Button was clicked")},onHover:function(){sap.m.MessageBox.alert("Button was Hovered")},onCourseSelect:function(e){var t=this.getView().byId("country").getSelectedKey();var a=this.getView().byId("course").getSelectedKey();var o=this.getView().getModel("local").getProperty("/courses");if(t==="IN"){for(var r=0;r<o.length;r++){if(o[r].courseName===a){this.getView().getModel("local").setProperty("/newLead/fees",o[r].fee);this.getView().getModel("local").setProperty("/newLead/currency","INR");break}}}else{for(var r=0;r<o.length;r++){if(o[r].courseName===a){this.getView().getModel("local").setProperty("/newLead/fees",o[r].usdFee);this.getView().getModel("local").setProperty("/newLead/currency","USD");break}}}},popupSave:function(){var e=this;var t={EmailId2:this.getView().getDependents()[0].getContent()[0].getContent()[1].getValue(),Remarks:this.getView().getDependents()[0].getContent()[0].getContent()[3].getValue()};e.ODataHelper.callOData(e.getOwnerComponent().getModel(),this.sPath,"PUT",{},t,e).then(function(t){sap.m.MessageToast.show("The Data has been updated successfully");e.inqChangeDialog.close()}).catch(function(t){e.getView().setBusy(false);var a=e.getErrorMessage(t)})},inqChangeDialog:null,onInqSelect:function(e){var t=this;this.sPath=e.getParameter("listItem").getBindingContextPath();var a=e.getSource().getModel().getProperty(this.sPath);var o=new sap.ui.model.json.JSONModel;o.setData({EmailId2:a.EmailId2,Remarks:a.Remarks});if(!this.inqChangeDialog){this.inqChangeDialog=new sap.m.Dialog({title:"Update Data"});this.inqChangeDialog.addButton(new sap.m.Button({text:"Save",press:[t.popupSave,t]}));this.inqChangeDialog.addButton(new sap.m.Button({text:"Cancel",press:function(){t.inqChangeDialog.close()}}));this.getView().addDependent(this.inqChangeDialog);var r=new sap.ui.layout.form.SimpleForm({content:[new sap.m.Label({text:"Email"}),new sap.m.Input({value:"{/EmailId2}"}),new sap.m.Label({text:"Remarks"}),new sap.m.Input({value:"{/Remarks}"})]});this.inqChangeDialog.addContent(r);this.inqChangeDialog.setModel(o)}else{this.inqChangeDialog.setModel(o)}this.inqChangeDialog.open()},reloadRefresh:function(){var e=this.getView().byId("idRecent");e.getBinding("items").refresh()},herculis:function(e){this.getView().getModel("local").setProperty("/valueHelpVisibility",true);var t=this.getView().getModel("local").getProperty("/newLead/EmailId");this.getView().getModel("local").setProperty("/newLeadVis",{EmailId:true,FatherName:true,MotherName:true,Date:true,City:true,Address:true,Phone:true,EmergencyContactName:true,SoftDelete:true,Remarks:true,HearAbout:true});this.getView().getModel("local").setProperty("/newWardVis",{Address:true,BloodGroup:true,CourseName:true,DOB:true,Gender:true,InquiryId:true,MobileNo:true,Name:true,Photo:true,RollNo:true,SchoolName:true,Standard:true,ToCourse:true,ToInquiry:true,Weakness:true});if(e.getParameter("name")==="leadDetail"){this.getView().getModel("local").setProperty("/clearVisibility",false);this.getView().getModel("local").setProperty("/bottomToolbar",false);this.getView().getModel("local").setProperty("/valueHelpVisibility",false);this.isLeadDetail=true;this.isWardDetail=true;this.getView().getModel("local").setProperty("/isLeadDetail",true);this.getView().getModel("local").setProperty("/toolbarVisibility",false);this.getView().getModel("local").setProperty("/newLead/EmailId",this.getView().getModel("local").getProperty("/Email"));this.getView().byId("idParentEmail").fireSubmit();this.getView().getModel("local").setProperty("/newLead/bottomToolbar",false)}this.getView().getModel("local").setProperty("/newLead/Date",new Date);this.getView().getModel("local").setProperty("/newLead/country","IN");var a=new Date;a.setHours(0,0,0,0);var o=new sap.ui.model.Sorter("CreatedOn",true)},onMobileNumber:function(e){if(e.getParameter("value").length>10){e.getSource().setValue(e.getParameter("value").substring(0,10));a.show("The number should not exceed 10 digits")}},onFullScreen:function(e){var t=e.getSource().getParent().getParent().getParent().getParent().getParent().getParent().getParent().getParent();var a=t.getMode();if(a==="ShowHideMode"){t.setMode("HideMode");e.getSource().setIcon("sap-icon://exit-full-screen");e.getSource().setText("Exit Fullscreen")}else{t.setMode("ShowHideMode");e.getSource().setIcon("sap-icon://full-screen");e.getSource().setText("Show Fullscreen")}},onParentMode:function(e){if(e.getParameter("state")){this.getView().byId("inqDate").setVisible(false);this.getView().byId("quotedFee").setVisible(false)}else{this.getView().byId("inqDate").setVisible(true);this.getView().byId("quotedFee").setVisible(true)}},onPressSendEmail:function(e){var t=this;var a=e.getSource().getParent().getParent();var o=a.getSelectedContextPaths();var r=this.getView().getModel("local").getProperty("/newLead");var s=[];var i=this.getView().getModel("local");o.forEach((e,t)=>{s.push(i.getProperty(e))});for(var n of s){var l={};l.FatherName=r.FatherName;l.EmailId=r.EmailId;l.WardName=`${n.Gender==="F"?"Miss":"Master"} ${n.Name}`;var u="<!DOCTYPE html>"+"<html>"+"\t<body>"+"\t\t<p>Dear $$FatherName$$, "+"<br>"+"We are excited to announce our upcoming summer camp for kids and we would like to invite your $$WardName$$ to be a part of it! Our summer camp is designed to provide an enriching and fun-filled experience for children while also allowing them to make new friends and learn new skills. "+" "+"<br>"+"The camp will be held from 20th May 2023 to 20th June 2023 and will feature a variety of activities such as Brain Development Skills, Multiple Intelligence, Coding, Art & Craft, and many more. Our team of experienced and enthusiastic counsellors will be there to guide your child throughout the camp, always ensuring their safety and well-being. We believe that this will be a wonderful opportunity for your child to make new friends, explore new interests, and have a great time. "+" "+"<br>"+"You can find the course details here "+" "+"<br>"+"https://www.evotrainingsolutions.com/evos-summer-camp "+" "+"<br>"+"We would be honored to have your children (Age 5-12 Years) join us at camp and we believe they will have an amazing time. Please let us know if you are interested in registering your child for the summer camp. If you have any questions or concerns, please do not hesitate to reach out to us. "+" "+"<br>"+"Evos Training Solutions, EPS-FF 074, Emerald Plaza, Sector-65, Gurgaon M: 8800156440 "+" "+"<br>"+"Thank you for considering our summer camp and we look forward to hearing from you soon!</p>"+"<br>"+"\t</body>"+"</html>";for(var d of n.CourseName){var g=this.getView().getModel().getProperty(`/CoursesMst('${d}')`);l.CourseName=g.CourseName;l.CourseFee=g.CourseFee;l.EmailTemplate=g.EmailTemplate?g.EmailTemplate:u;t.getView().setBusy(true);$.post("/sendInquiryEmail",l).done(function(e,o){sap.m.MessageToast.show("Email sent successfully");a.removeSelections();t.getView().setBusy(false)}).fail(function(e,a,o){t.getView().setBusy(false);sap.m.MessageBox.error(e.responseText)})}}},onPressAddWard:function(){var e=this.getView().getModel("local").getProperty("/newLead/WardDetails");e.push({RollNo:null,Name:null,Gender:"F",DOB:new Date,Standard:null,SchoolName:null,Weakness:null,MobileNo:null,CourseName:[],Address:null,BloodGroup:null,Photo:null});this.getView().getModel("local").setProperty("/newLead/WardDetails",e)},onPressDeleteRow:function(e){var t=e.getSource().getParent().getParent().getSelectedContextPaths();var a=[];t.forEach(e=>{a.push(parseInt(e.split("/")[3]))});a.sort((e,t)=>t-e);var o=this.getView().getModel("local").getProperty("/newLead/WardDetails");a.forEach(e=>{o.splice(e,1)});this.getView().getModel("local").setProperty("/newLead/WardDetails",o);e.getSource().getParent().getParent().removeSelections()},onEnter:function(e){var o=e.getParameters().value;if(o&&o.toString().length!==10){a.show("Please Enter a Valid Mobile Number");return}var r=this;var s=new sap.ui.model.Filter("Phone","EQ",o);this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Inquries?$select=id","GET",{filters:[s],urlParameters:{$select:"id,Phone"}},{},this).then(function(e){if(e.results.length>0){r.loadInquiry(e.results[0].id)}else{t.show("No Matching Record Found!",{onClose:function(){r.getView().byId("idParentEmail").focus()}})}}).catch(function(e){a.show(e.responseText)})},onEnterEmail:function(e){var t=e.getSource().getValue();if(!t){t=e.getParameter("value")}var o=this;var r=new sap.ui.model.Filter("EmailId","EQ",t);this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Inquries?$select=id","GET",{filters:[r],urlParameters:{$select:"id,EmailId"}},{},this).then(function(e){if(e.results.length>0){o.loadInquiry(e.results[0].id)}else{o.onClearForm();o.getView().getModel("local").setProperty("/newLead/EmailId",t)}}).catch(function(e){a.show(e.responseText)})},onSelectInq:function(e){this.getCustomerPopup();this.flag="inquiry";this.searchPopup.setTitle("Inquiries");this.searchPopup.bindAggregation("items",{path:"/Inquries",template:new sap.m.ObjectListItem({title:"{FatherName}",intro:"{EmailId}",number:"{Phone}",numberUnit:"{=${MotherName}? 'Mother: '+${MotherName} : ${MotherName}}"})})},onConfirm:function(e){var t=e.getParameter("selectedItem").getBindingContextPath();var a=this.getView().getModel().getProperty(t).id;var o=this;var r="Inquries('"+a+"')";var s=this.getView().getModel().oData[r];o.loadInquiry(s.id)},loadInquiry:function(e){this.flag="inquiry";var t=this;var a="Inquries('"+e+"')";t.getView().setBusy(true);t.ODataHelper.callOData(t.getOwnerComponent().getModel(),`/${a}`,"GET",{},{},t).then(function(e){t.getView().getModel("local").setProperty("/newLead",e);if(t.isLeadDetail){var o={};for(const t in e){o[t]=e[t]?false:true}t.getView().getModel("local").setProperty("/newLeadVis",o)}t.ODataHelper.callOData(t.getOwnerComponent().getModel(),`/${a}/ToWard`,"GET",{},{},t).then(function(e){t.getView().getModel("local").setProperty("/newLead/WardDetails",e.results);var a=e.results;for(let e=0;e<a.length;e++){const o=a[e];for(const e in o){newWardVis[e]=o[e]?false:true}t.getView().getModel("local").setProperty("/newWardVis",newWardVis)}t.getView().setBusy(false)}).catch(function(e){t.getView().setBusy(false)})}).catch(function(e){t.getView().setBusy(false)})},onSearch:function(e){var t=this.getQuery(e);if(t){var a=new sap.ui.model.Filter("FatherName",sap.ui.model.FilterOperator.Contains,t);var o=new sap.ui.model.Filter("MotherName",sap.ui.model.FilterOperator.Contains,t);var r=new sap.ui.model.Filter("Phone",sap.ui.model.FilterOperator.Contains,t);var s=new sap.ui.model.Filter("EmailId",sap.ui.model.FilterOperator.Contains,t);var i=new sap.ui.model.Filter({filters:[a,o,r,s],and:false});var n=[i];this.searchPopup.getBinding("items").filter(n)}else{this.searchPopup.getBinding("items").filter([])}},onCancel:function(){this.flag=null},supplierPopup:null,oInp:null,onPopupConfirm:function(e){var t=e.getParameter("selectedItem");this.oInp.setValue(t.getLabel())},oSuppPopup:null,onFilter:function(){if(!this.oSuppPopup){this.oSuppPopup=new sap.ui.xmlfragment("oft.fiori.fragments.popup",this);this.getView().addDependent(this.oSuppPopup);this.oSuppPopup.setTitle("Suppliers");this.oSuppPopup.bindAggregation("items",{path:"/suppliers",template:new sap.m.DisplayListItem({label:"{name}",value:"{city}"})})}this.oSuppPopup.open()},onRequest:function(e){this.oInp=e.getSource();if(!this.supplierPopup){this.supplierPopup=new sap.ui.xmlfragment("oft.fiori.fragments.popup",this);this.supplierPopup.setTitle("Cities");this.getView().addDependent(this.supplierPopup);this.supplierPopup.bindAggregation("items",{path:"/cities",template:new sap.m.DisplayListItem({label:"{cityName}",value:"{famousFor}"})})}this.supplierPopup.open()},onSave:function(e){var a=e;console.log(this.getView().getModel("local").getProperty("/newLead"));var o=this;var r=this.getView().getModel("local").getProperty("/newLead");if(!this.getView().byId("inqDate").getDateValue()){sap.m.MessageToast.show("Enter a valid Date");return""}if(!r.Phone){sap.m.MessageToast.show("Please Enter Mobile No.");return""}var s={EmailId:r.EmailId.toLowerCase(),RollNo:r.RollNo,FatherName:r.FatherName,MotherName:r.MotherName,EmailId2:r.EmailId2,Date:this.getView().byId("inqDate").getDateValue(),City:r.City,Address:r.Address,EmergencyContactName:r.EmergencyContactName,EmergencyContactNo:r.EmergencyContactNo,Phone:r.Phone,Remarks:r.Remarks,HearAbout:r.HearAbout,SoftDelete:false,CreatedOn:new Date,ChangedOn:new Date,ChangedBy:""};var i=r.WardDetails;if(i.filter(function(e){return!e.Name}).length>0){t.error("Ward Name Can't be Empty!");return}o.getView().setBusy(true);if(this.flag==="inquiry"){this.ODataHelper.callOData(this.getOwnerComponent().getModel(),`/Inquries('${r.id}')`,"PUT",{},s,this).then(function(e){const t=r.id;if(i.length>0){o.saveWard(i,0,t)}else{sap.m.MessageToast.show("Inquiry Saved successfully");o.loadInquiry(t)}}).catch(function(e){t.error(e.responseText);o.getView().setBusy(false)})}else{const e=[];e.push(new Promise((e,a)=>{this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Inquries","POST",{},s,this).then(function(e){const t=e.id;if(i.length>0){o.saveWard(i,0,t)}else{sap.m.MessageToast.show("Inquiry Saved successfully");o.loadInquiry(t)}}).catch(function(e){t.error(e.responseText);o.getView().setBusy(false);a(e)})}))}},saveWard:function(e,t,a){var o=this;const r={InquiryId:a,RollNo:e[t].RollNo,Name:e[t].Name,Gender:e[t].Gender,DOB:e[t].DOB,Standard:e[t].Standard,SchoolName:e[t].SchoolName,Weakness:e[t].Weakness,MobileNo:e[t].MobileNo,CourseName:e[t].CourseName,Address:e[t].Address,BloodGroup:e[t].BloodGroup,Photo:e[t].Photo};o.ODataHelper.callOData(o.getOwnerComponent().getModel(),e[t].id?`/Wards('${e[t].id}')`:"/Wards",e[t].id?"PUT":"POST",{},r,o).then(function(r){if(++t<e.length){o.saveWard(e,t,a)}else{sap.m.MessageToast.show("Inquiry Saved successfully");o.loadInquiry(a)}}).catch(function(r){if(++t<e.length){o.saveWard(e,t,a)}else{sap.m.MessageToast.show("Inquiry Saved successfully");o.loadInquiry(a)}})},onApprove:function(){t.confirm("Do you want to approve this fruit",{title:"confirmation",onClose:this.onConfirm.bind(this)})},onGetNext:function(){$.post("/MoveNextAc",{}).done(function(e,t){sap.m.MessageBox.confirm("Bank Name    : "+e.BankName+"\n"+"Account Name : "+e.accountName+"\n"+"Account No   : "+e.accountNo+"\n"+"IFSC Code    : "+e.ifsc+"\n"+"\n"+"Note: Please send the screenshot of payment once done.")}).fail(function(e,t,a){sap.m.MessageBox.error(e.responseText)})},onUpdateFinished:function(e){var t=e.getSource();var a=t.getItems();var o=a.length;for(var r=0;r<o;r++){var s=t.getItems()[r].mBindingInfos.label.binding.aValues[1];var i=a[r].mProperties.label;var n=a[r].mProperties.value.split("/");var l="CoursesMst('"+s.trim()+"')";var u=this.getView().getModel().oData[l];var d=a[r].mProperties.value.split("-")[1].trim();if(u){var g=a[r].mProperties.label.replace(s.trim(),u.CourseName);if(this.getView().getModel("local").getProperty("/AppUsers")[d]){var c=a[r].mProperties.value.replace(d,this.getView().getModel("local").getProperty("/AppUsers")[d].UserName);t.getItems()[r].setValue(c)}t.getItems()[r].setLabel(g)}}}})});