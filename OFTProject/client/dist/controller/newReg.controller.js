var courseGUID;var customerGUID;var vEmail;var CourseFee;sap.ui.define(["oft/fiori/controller/BaseController","sap/m/MessageBox","sap/m/MessageToast","oft/fiori/models/formatter","sap/ui/model/Filter","sap/m/Token","sap/ui/model/FilterOperator","sap/ui/core/Fragment","sap/ui/export/Spreadsheet","sap/ui/export/library"],function(e,t,a,s,i,r,o,l,n,u){"use strict";return e.extend("oft.fiori.controller.newReg",{formatter:s,fnOnUpLoadFile:function(e){var t=this.getView().byId("imageUploader");var a=t.getFocusDomRef();var s=a.files[0];var i=this;if(s){var i=this;this.fileName=s.name;this.fileType=s.type;var r=new FileReader;r.onload=function(e){i.imgContent=e.currentTarget.result};r.readAsDataURL(s)}},handleTypeMissmatch:function(e){var t=e.getSource().getFileType();jQuery.each(t,function(e,a){t[e]="*."+a});var s=t.join(", ");a.show("The file type *."+e.getParameter("fileType")+" is not supported. Choose one of the following types: "+s)},handleSizeExceed:function(e){var t=e.getSource().getMaximumFileSize();a.show("Maximun file size allowed is "+t+" MB")},onScreenShot:function(e){var t=this;var a=e.getSource().getBindingContext().sPath;this.ODataHelper.callOData(this.getOwnerComponent().getModel(),a,"GET",{},{},this).then(function(e){var t=e.PaymentScreenshot;var a=new sap.m.Dialog({title:"Payment Screen Shot"});a.addButton(new sap.m.Button({text:"OK",press:function(){a.close();a.destroyContent()}}));var s=new sap.m.Carousel({loop:true});var i=new sap.m.Image({src:t,alt:"",densityAware:true,decorative:false});s.addPage(i);a.addContent(s);a.open()}).catch(function(e){var a=t.getErrorMessage(e)})},onInit:function(){this.oRouter=sap.ui.core.UIComponent.getRouterFor(this);this.totalCount=0;var e=this.getModel("local").getProperty("/CurrentUser");if(e){var t=this.getModel("local").oData.AppUsers[e].UserName}t="Hey "+t;this.getView().byId("idUser").setText(t);this.UserRole=this.getOwnerComponent().getModel("local").getProperty("/Role");var a=this.getOwnerComponent().getModel();var s=new sap.ui.model.json.JSONModel;a.read("/Wards",{success:function(e,t){s.setData(e)},error:function(e){}});var i=this.getOwnerComponent().getModel();i.read("/Courses",{success:function(e,t){s.setData(e)},error:function(e){}});this.oRouter.attachRoutePatternMatched(this.herculis,this)},onBack:function(){sap.ui.getCore().byId("idApp").to("idView1")},siteLink:"",eMailId:"",onGiveAccess:function(e){var t=this;var a=t.getView().byId("idSubsRecent").getSelectedContexts();for(var s=0;s<a["length"];s++){var i=a[s].getModel().getProperty(a[s].getPath());$.post("/giveAccess",i).done(function(e,t){sap.m.MessageToast.show("Access has been provided")}).fail(function(e,t,a){sap.m.MessageBox.error("Error in access")})}},onClearToken:function(){$.post("/clearToken").done(function(e,t){sap.m.MessageToast.show("Token is now reset")}).fail(function(e,t,a){sap.m.MessageBox.error("Error in access")})},onSendEmail:function(e){var t=this;var a=t.getView().byId("idSubsRecent").getSelectedContexts();for(var s=0;s<a["length"];s++){var i=a[s].getModel().getProperty(a[s].getPath());var t=this;var r={Status:"Access Granted"};if(this.passwords===""){this.passwords=prompt("Please enter your password","");if(this.passwords===""){sap.m.MessageBox.error("Blank Password not allowed");return}}i.password=t.passwords;i.includeX=t.getView().byId("includeX").getSelected();$.post("/sendSubscriptionEmail",i).done(function(e,t){sap.m.MessageToast.show("Email sent successfully")}).fail(function(e,a,s){t.passwords="";sap.m.MessageBox.error(e.responseText)})}},oSuppPopup:null,destoryDialog:function(){this.oSuppPopup.destroy();this.oSuppPopup=null},onItemPress:function(e){if(!this.oSuppPopup){this.oSuppPopup=new sap.ui.xmlfragment("oft.fiori.fragments.subSearch",this);sap.ui.getCore().getMessageManager().registerObject(this.oSuppPopup,true);this.getView().addDependent(this.oSuppPopup)}sap.ui.getCore().byId("updPay").setVisible(false);sap.ui.getCore().byId("idPortSubs").setVisible(false);sap.ui.getCore().byId("idExtendSubs").setVisible(false);var t=e.getSource().oBindingContexts.undefined.sPath;t=t.split("/")[1];var a=this.getView().getModel().oData[t];sap.ui.getCore().byId("idCourse_upd").setEnabled(false);sap.ui.getCore().byId("idPayDate_upd").setEnabled(false);sap.ui.getCore().byId("idEndDate_upd").setEnabled(false);sap.ui.getCore().byId("paymentMode_upd").setEnabled(false);sap.ui.getCore().byId("accountDetails_upd").setEnabled(false);sap.ui.getCore().byId("idAmount_upd").setEnabled(false);sap.ui.getCore().byId("idAmount_Txt").setText("Amount");sap.ui.getCore().byId("idReference_upd").setEnabled(false);sap.ui.getCore().byId("idRemarks_upd").setEnabled(false);sap.ui.getCore().byId("idPendingAmount_upd").setEnabled(false);sap.ui.getCore().byId("idPayDueDate_upd").setEnabled(false);this.customerEmail=e.getSource().mAggregations.cells[0].mProperties.text;this.courseName=e.getSource().mAggregations.cells[1].mProperties.text;this.prevPendingAmiount=a.PendingAmount;this.getView().getModel("local").setProperty("/newRegistration/StudentId",this.customerEmail);this.getView().getModel("local").setProperty("/newRegistration/CourseId",this.courseName);this.getView().getModel("local").setProperty("/newRegistration/PaymentMode",a.PaymentMode);this.getView().getModel("local").setProperty("/newRegistration/AccountName",a.AccountName);this.getView().getModel("local").setProperty("/BeneficiaryName",this.getAccountBeneficiary(a.AccountName));this.getView().getModel("local").setProperty("/newRegistration/Amount",a.Amount);this.getView().getModel("local").setProperty("/newRegistration/PendingAmount",a.PendingAmount);this.getView().getModel("local").setProperty("/newRegistration/Reference",a.Reference);this.getView().getModel("local").setProperty("/newRegistration/Remarks",a.Remarks);this.oSuppPopup.open()},onDelete:function(e){var a=this;t.confirm("Do you want to delete the selected records?",function(e){if(e=="OK"){var t=a.getView().byId("idSubsRecent").getSelectedContexts();for(var s=0;s<t["length"];s++){a.ODataHelper.callOData(a.getOwnerComponent().getModel(),t[s].sPath,"DELETE",{},{},a).then(function(e){sap.m.MessageToast.show("Deleted succesfully")}).catch(function(e){a.getView().setBusy(false);a.oPopover=a.getErrorMessage(e);a.getView().setBusy(false)})}}},"Confirmation")},onRefresh:function(){var e=this.getView().byId("idPayDate");var t=e._lastValue.split(".");var a=new Date(t[2],t[1]-1,t[0]);a.setHours(0,0,0,0);var s=new sap.ui.model.Sorter("CreatedOn",true);var i=new sap.ui.model.Filter("PaymentDate","GE",a);var r=this.getView().byId("idSubsRecent");var o=r.getItems();r.getBinding("items").filter(i);r.getBinding("items").sort(s)},onSaveSubs:function(e){this.subsciptionSaved="false";var t=e;var a=this;var s=this.getView().getModel("local").getProperty("/newRegistration");var i=false;if(this.getView().byId("idPayDate").getDateValue()){i=this.formatter.getDateCheck(this.getView().byId("idPayDate").getDateValue());if(i==true){sap.m.MessageToast.show("Payment Date can't be in future");return""}}if(this.getView().byId("idRegDate").getDateValue()){i=false;i=this.formatter.getDateCheck(this.getView().byId("idRegDate").getDateValue());if(i==true){sap.m.MessageToast.show("Registration Date can't be in future");return""}}if(!this.getView().byId("idAmount").getValue()||this.getView().byId("idAmount").getValue()<=0){if(this.getView().byId("idAmount").getValue()==0){if(this.getView().byId("idWaiver").getSelected()==false){if(this.getView().byId("idPartPay").getSelected()==false){sap.m.MessageToast.show("Amount can't be 0, if waiver/partial payment not applied");return""}}}else if(this.getView().byId("idAmount").getValue()<0){sap.m.MessageToast.show("Amount can't be less than 0");return""}}if(this.getView().byId("idPendingAmount").getValue()<0){sap.m.MessageToast.show("Pending Amount can't be less than 0");return""}else if(this.getView().byId("idPendingAmount").getValue()>0){if(this.getView().byId("idPartPay").getSelected()==false){sap.m.MessageToast.show('Please check "Partial Payment" flag as Pending Amount is there');return""}}else if(this.getView().byId("idPendingAmount").getValue()==0){if(this.getView().byId("idPartPay").getSelected()==true){sap.m.MessageToast.show('Please uncheck "Partial Payment" flag as Pending Amount is 0');return""}}if(this.getView().byId("idPayDueDate").getDateValue()){var r=this.getView().byId("idPayDueDate").getValue().split(".");var o=this.getView().byId("idPayDate").getValue().split(".");o=o[2]+o[1]+o[0];r=r[2]+r[1]+r[0];if(o>r){sap.m.MessageToast.show("Payment Due Date can't be less than Payment Date");return""}}var l=null;if(this.UserRole=="Admin"){l="Approved"}else{l="Pending"}a.getView().setBusy(false);var n={StudentId:this.customerId,CourseId:this.courseId,PaymentDate:this.getView().byId("idPayDate").getDateValue(),Mode:s.Mode,StartDate:this.getView().byId("idRegDate").getDateValue(),PaymentMode:s.PaymentMode,BankName:s.BankName,AccountName:s.AccountName,Amount:s.Amount,Reference:s.Reference,Remarks:s.Remarks,PendingAmount:s.PendingAmount,Waiver:s.Waiver,PartialPayment:s.PartialPayment,PaymentDueDate:this.getView().byId("idPayDueDate").getDateValue(),PaymentScreenshot:this.imgContent,CreatedOn:new Date,CreatedBy:"DemoUser",ChangedOn:new Date,ChangedBy:"DemoUser",DropOut:false,Extra1:" ",Extra2:s.Extra2,ExtraN1:s.ExtraN1,ExtraN2:0,ExtraN3:0,UpdatePayment:false,MostRecent:true,Status:l};this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Subs","POST",{},n,this).then(function(e){a.getView().setBusy(false);a.subsciptionSaved="true";sap.m.MessageToast.show("Subscription Saved successfully");a.destroyMessagePopover()}).catch(function(e){a.getView().setBusy(false);a.subsciptionSaved="false";var t=a.getErrorMessage(e)});this.getView().getModel().refresh()},onStartChange:function(e){var t=e.getSource().getValue();var a=t.split(".");var s=new Date(a[2],a[1]-1,a[0])},onPayDateChange:function(e){var t=e.getSource().getValue();var a=t.split(".");var s=new Date(a[2],a[1]-1,a[0]);var i=new Date(a[2],a[1]-1,a[0]);var r=this.formatter.getIncrementDate(s,1);this.getView().getModel("local").setProperty("/newRegistration/PaymentDueDate",r);i.setHours(0,0,0,0);var o=new sap.ui.model.Sorter("CreatedOn",true);var l=new sap.ui.model.Filter("PaymentDate","GE",i);var n=this.getView().byId("idSubsRecent");var u=n.getItems();n.getBinding("items").filter(l);n.getBinding("items").sort(o)},herculis:function(e){if(e.getParameter("name")!=="newreg"){return}var t=new Date;t.setHours(0,0,0,0);var a=new sap.ui.model.Sorter("CreatedOn",true);var s=this.getView().byId("idSubsRecent");var i=s.getItems();var r=new sap.ui.model.Filter("PaymentDate","GE",t);s.getBinding("items").filter(r);s.getBinding("items").sort(a);this.getView().getModel("local").setProperty("/newRegistration/StartDate",this.formatter.getFormattedDate(0));this.getView().getModel("local").setProperty("/newRegistration/PaymentDate",this.formatter.getFormattedDate(0));this.getView().getModel("local").setProperty("/newRegistration/PaymentDueDate",this.formatter.getFormattedDate(1));this.getView().getModel("local").setProperty("/newRegistration/StudentId",null);this.getView().getModel("local").setProperty("/newRegistration/CourseId",null);this.getView().getModel("local").setProperty("/newRegistration/Mode","L");this.getView().getModel("local").setProperty("/newRegistration/PaymentMode","IMPS");this.getView().getModel("local").setProperty("/newRegistration/AccountName",null);this.getView().getModel("local").setProperty("/newRegistration/Amount",15e3);this.getView().getModel("local").setProperty("/newRegistration/PendingAmount",0);this.getView().getModel("local").setProperty("/newRegistration/PartialPayment",false);this.getView().getModel("local").setProperty("/newRegistration/Reference",null);this.getView().getModel("local").setProperty("/newRegistration/Extra2",null);this.getView().getModel("local").setProperty("/newRegistration/Waiver",false);this.getView().getModel("local").setProperty("/newRegistration/Waiver",false);this.getView().getModel("local").setProperty("/newRegistration/Waiver",false);this.getView().getModel("local").setProperty("/newCustomer/GmailId",null);this.getView().getModel("local").setProperty("/newCustomer/Name",null);this.getView().getModel("local").setProperty("/newCustomer/Country","IN");this.getView().getModel("local").setProperty("/newCustomer/ContactNo",null);this.getView().getModel("local").setProperty("/newCustomer/OtherEmail1",null);this.getView().getModel("local").setProperty("/newCustomer/OtherEmail2",null);this.getView().getModel("local").setProperty("/newCustomer/Skills",null);this.getView().getModel("local").setProperty("/newCustomer/Star",false);this.getView().getModel("local").setProperty("/newCustomer/Defaulter",false)},oSuppPopup:null,onCustomer:function(){if(!this.oSuppPopup){this.oSuppPopup=new sap.ui.xmlfragment("oft.fiori.fragments.newCustomer",this);sap.ui.getCore().getMessageManager().registerObject(this.oSuppPopup,true);this.getView().addDependent(this.oSuppPopup);this.oSuppPopup.setTitle("New Customer")}this.getView().getModel("local").setProperty("/newCustomer/GmailId",null);this.getView().getModel("local").setProperty("/newCustomer/Name",null);this.getView().getModel("local").setProperty("/newCustomer/Country","IN");this.getView().getModel("local").setProperty("/newCustomer/ContactNo",null);this.getView().getModel("local").setProperty("/newCustomer/OtherEmail1",null);this.getView().getModel("local").setProperty("/newCustomer/OtherEmail2",null);this.getView().getModel("local").setProperty("/newCustomer/Skills",null);this.getView().getModel("local").setProperty("/newCustomer/Star",false);this.getView().getModel("local").setProperty("/newCustomer/Defaulter",false);this.getView().getModel("local").setProperty("/newCustomer/HighServerUsage",false);sap.ui.getCore().byId("idSkills").clearSelection();this.oSuppPopup.open()},onUpdateFinished:function(e){var t=this.getView().byId("idSubsRecent");var a=t.getItems();var s=a.length;var i;var r;var o;var l=0;for(var n=0;n<a.length;n++){l=l+parseInt(a[n].getCells()[5].getText())}t.getHeaderToolbar().getContent()[0].setText("Today: "+s+"  Amount: "+l);for(var n=0;n<s;n++){var u=a[n].getCells()[1].getText();var g="Courses('"+u+"')";var d=this.getView().getModel().oData[g];if(d){var p=d.BatchNo;a[n].getCells()[1].setText(p)}var c=a[n].getCells()[0].getText();var m="Wards('"+c+"')";var h=this.getView().getModel().oData[m];if(h){var f=h.Name+"("+h.RollNo+")";a[n].getCells()[0].setText(f)}var y=a[n].getCells()[2].getItems()[0].getText();if(y==="Approved"){a[n].getCells()[2].getItems()[0].setText("Send Mail");a[n].getCells()[2].getItems()[0].setEnabled(true);a[n].getCells()[2].getItems()[0].setType(sap.m.ButtonType.Unstyled)}else if(y==="Pending"){a[n].getCells()[2].getItems()[0].setText("Approve");a[n].getCells()[2].getItems()[0].setType(sap.m.ButtonType.Reject)}else if(y.toLowerCase()==="access granted"){a[n].getCells()[2].getItems()[0].setEnabled(false);a[n].getCells()[2].getItems()[0].setType(sap.m.ButtonType.Accept)}o=a[n].getCells().length-2;r=a[n].getCells()[4].getText();if(this.getModel("local").getProperty("/AppUsers")[r]){i=this.getModel("local").getProperty("/AppUsers")[r].UserName}if(i){a[n].getCells()[4].setText(i)}}},passwords:"",onBank:function(e){this.oEvent_approve=e;var t=e.getSource().getBindingContext().sPath;var a=this;var s=a.oEvent_approve.getSource().getBindingContext().getModel().getProperty(a.oEvent_approve.getSource().getBindingContext().getPath());if(s.AccountName){this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Accounts","GET",{filters:[new sap.ui.model.Filter("accountNo","EQ",s.AccountName)]},{},this).then(function(e){console.log(e.results[0].userId);try{navigator.clipboard.writeText(e.results[0].userId)}catch(e){}finally{}window.open(e.results[0].extra1)}).catch(function(e){a.getView().setBusy(false);var t=a.getErrorMessage(e)})}},onApprove:async function(e){var t=e;var s=this;var i=e.getSource().getParent().getBindingContext().getObject();var r=e.getSource();console.log(i);var o=i.Amount;var l=i.PaymentMode;var n=i.PaymentDate;var u=i.CreatedOn;var g=i.StudentId;var d=i.CourseId;var p;var c;var m;var h;var f;this.oEvent_approve=e;var y="/Wards('"+g+"')/ToInquiry";await this.ODataHelper.callOData(this.getOwnerComponent().getModel(),y,"GET",null,null,this).then(function(e){m=e.FatherName;f=e.EmailId;h=e.Phone}).catch(function(e){});var w="Wards('"+g+"')";var C=this.getView().getModel().oData[w];if(C){p=C.Name}var P="Courses('"+d+"')";var v=this.getView().getModel().oData[P];if(v){c=v.BatchNo}var b=new Date(u);var I=b.toLocaleDateString();var n=new Date(n);var V=n.toLocaleDateString();$.ajax({url:"sendPaymentVerificationEmail",type:"POST",data:{Parent_Name:m,Camper_Name:p,Camp_Program_Name:c,Program_Dates:I,Payment_Amount:o,Payment_Date:V,Payment_Method:l,Email:f},success:function(e){if(e=="Email sent successfully"){a.show("Email sent Successfully");if(r.getText()=="Send Mail"){r.setEnabled(false);s.statusChange(r)}}},error:function(e){console.log(e)}});$.ajax({type:"POST",url:"requestMessage",data:{Number:h,msgType:"WARDREG"},success:function(e){console.log("success: "+e);a.show("OTP Successfully Sent")},error:function(e,t,s){console.error(s);a.show("Error sending OTP via email")}})},statusChange:function(e){if(e.getText()=="Approve"){var t=e.getBindingContext().sPath;var a=this;var s={Status:"Approved"};this.ODataHelper.callOData(this.getOwnerComponent().getModel(),t,"PUT",{},s,this).then(function(e){}).catch(function(e){a.getView().setBusy(false);var t=a.getErrorMessage(e)})}else if(e.getText()=="Send Mail"){var t=e.getBindingContext().sPath;var a=this;var s={Status:"Access Granted"};this.ODataHelper.callOData(this.getOwnerComponent().getModel(),t,"PUT",{},s,this).then(function(e){}).catch(function(e){a.getView().setBusy(false);var t=a.getErrorMessage(e)})}},onPopinChanged:function(e){var t=e.getParameter("hiddenInPopin");a.show("Number of hidden pop-ins: "+t.length)},searchPopup:null,onSelect:function(e){this.sId=e.getSource().getId();var t="",a="";if(this.sId.indexOf("customerId")!==-1){this.getCustomerPopup();var s=this.getView().getModel("i18n").getProperty("customer");this.searchPopup.setTitle(s);this.searchPopup.bindAggregation("items",{path:"/Wards",template:new sap.m.ObjectListItem({title:"{Name}",intro:"{SchoolName}",number:"{RollNo}"})})}else if(this.sId.indexOf("idEmailCust")!==-1){this.getCustomerPopup();var s=this.getView().getModel("i18n").getProperty("customer");this.searchPopup.setTitle(s);this.searchPopup.bindAggregation("items",{path:"/Inquries",template:new sap.m.DisplayListItem({label:"{EmailId}",value:"{FirstName}"})})}else if(this.sId.indexOf("courseId")!==-1){var i=new sap.ui.model.Filter("hidden",o.EQ,false);this.getCustomerPopup();var s=this.getView().getModel("i18n").getProperty("batch");this.searchPopup.setTitle(s);this.searchPopup.bindAggregation("items",{path:"/Courses",filters:[i],template:new sap.m.ObjectListItem({title:"{Name}",intro:"{BatchNo}",number:{path:"status",formatter:this.formatter.formatStatusValue}})});var r=this.searchPopup.getBinding("items");var l=[];var n="EndDate";var u=true;r.sort(l)}else if(this.sId.indexOf("accountDetails")!==-1){var g=new sap.ui.model.Filter("deleted",o.EQ,false);t="Account Search";a="local>/accountSet";this.getCustomerPopup();var s="Account Search";var d=new sap.ui.model.Sorter({path:"value",descending:false});this.searchPopup.setTitle(s);this.searchPopup.bindAggregation("items",{path:"local>/accountSet",filters:[g],sorter:d,template:new sap.m.DisplayListItem({label:"{local>value}",value:"{local>key}"})})}},onConfirm:function(e){if(this.sId.indexOf("accountDetails")!==-1){var t=e.getParameter("selectedItem").getValue();this.getView().getModel("local").setProperty("/newRegistration/AccountName",t)}else if(this.sId.indexOf("customerId")!==-1){var a=this.getObjListSelectedkey(e);this.getView().byId("customerId").setValue(a[0]);this.customerId=a[3]}else if(this.sId.indexOf("courseId")!==-1){var a=this.getObjListSelectedkey(e);this.getView().byId("idCourseName").setText(a[0]);this.getView().byId("courseId").setValue(a[1]);this.courseId=a[3];var s=e.getParameter("selectedItem");var i=s.getBindingContext();if(i.getObject().Fee){this.getView().byId("idAmount").setValue(i.getObject().Fee);CourseFee=i.getObject().Fee}else{CourseFee=0}var r=new Date(i.getObject().DemoStartDate);r.setMonth(r.getMonth()+1);if(r>new Date){this.getView().byId("idPayDueDate").setDateValue(r)}}else if(this.sId.indexOf("idEmailCust")!==-1){var s=e.getParameter("selectedItem");var i=s.getBindingContext();sap.ui.getCore().byId("idSkills").clearSelection();sap.ui.getCore().byId("idPhone").setValue(0);sap.ui.getCore().byId("idCountry").setSelectedKey("IN");sap.ui.getCore().byId("idOtherEmail1").setValue(null);sap.ui.getCore().byId("idOtherEmail2").setValue(null);sap.ui.getCore().byId("idStar").setSelected(false);sap.ui.getCore().byId("idName").setValue(null);sap.ui.getCore().byId("idDefaulter").setSelected(false);sap.ui.getCore().byId("idHighServerUsage").setSelected(false);if(i){var o=this;var l={};var n=new sap.ui.model.Filter("GmailId","EQ",i.getObject().EmailId);this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Students","GET",{filters:[n]},l,this).then(function(e){if(e.results.length!=0){sap.ui.getCore().byId("idEmailCust").setValue(e.results[0].GmailId);sap.ui.getCore().byId("idName").setValue(e.results[0].Name);if(e.results[0].ContactNo){sap.ui.getCore().byId("idPhone").setValue(e.results[0].ContactNo)}else{sap.ui.getCore().byId("idPhone").setValue(0)}if(e.results[0].Country){sap.ui.getCore().byId("idCountry").setSelectedKey(e.results[0].Country)}else{sap.ui.getCore().byId("idCountry").setSelectedKey("IN")}if(e.results[0].OtherEmail1){sap.ui.getCore().byId("idOtherEmail1").setValue(e.results[0].OtherEmail1)}if(e.results[0].OtherEmail2){sap.ui.getCore().byId("idOtherEmail2").setValue(e.results[0].OtherEmail2)}if(e.results[0].Defaulter){sap.ui.getCore().byId("idDefaulter").setSelected(e.results[0].Defaulter)}if(e.results[0].HighServerUsage){sap.ui.getCore().byId("idHighServerUsage").setSelected(e.results[0].HighServerUsage)}if(e.results[0].Star){sap.ui.getCore().byId("idStar").setSelected(e.results[0].Star)}sap.ui.getCore().byId("createNew").setText("Update");o.UpdateCustomer=true;o.customerGUID=e.results[0].id}else{var t;var a;sap.ui.getCore().byId("idEmailCust").setValue(i.getObject().EmailId);if(i.getObject().FirstName){if(i.getObject().LastName){t=i.getObject().LastName}else{t=" "}sap.ui.getCore().byId("idName").setValue(i.getObject().FirstName+" "+t)}else{a="";if(i.getObject().LastName){t=i.getObject().LastName}else{t=""}sap.ui.getCore().byId("idName").setValue(a+" "+t)}if(i.getObject().Phone){sap.ui.getCore().byId("idPhone").setValue(i.getObject().Phone)}else{sap.ui.getCore().byId("idPhone").setValue(0)}if(i.getObject().Country){sap.ui.getCore().byId("idCountry").setSelectedKey(i.getObject().Country)}else{sap.ui.getCore().byId("idCountry").setSelectedKey("IN")}sap.ui.getCore().byId("createNew").setText("Create");o.UpdateCustomer=false}}).catch(function(e){var t;var a;sap.ui.getCore().byId("idEmailCust").setValue(i.getObject().EmailId);if(i.getObject().FirstName){if(i.getObject().LastName){t=i.getObject().LastName}else{t=" "}sap.ui.getCore().byId("idName").setValue(i.getObject().FirstName+" "+t)}else{a="";if(i.getObject().LastName){t=i.getObject().LastName}else{t=""}sap.ui.getCore().byId("idName").setValue(a+" "+t)}if(i.getObject().Phone){sap.ui.getCore().byId("idPhone").setValue(i.getObject().Phone)}else{sap.ui.getCore().byId("idPhone").setValue(0)}if(i.getObject().Country){sap.ui.getCore().byId("idCountry").setSelectedKey(i.getObject().Country)}else{sap.ui.getCore().byId("idCountry").setSelectedKey("IN")}sap.ui.getCore().byId("createNew").setText("Create");o.UpdateCustomer=false})}}},suggestionItemSelected:function(e){var t=e.getParameter("selectedItem");var a=t.getBindingContext();sap.ui.getCore().byId("idSkills").clearSelection();sap.ui.getCore().byId("idPhone").setValue(0);sap.ui.getCore().byId("idCountry").setSelectedKey("IN");sap.ui.getCore().byId("idOtherEmail1").setValue(null);sap.ui.getCore().byId("idOtherEmail2").setValue(null);sap.ui.getCore().byId("idStar").setSelected(false);sap.ui.getCore().byId("idName").setValue(null);sap.ui.getCore().byId("idDefaulter").setSelected(false);sap.ui.getCore().byId("idHighServerUsage").setSelected(false);if(a){var s=this;var i={};var r=new sap.ui.model.Filter("GmailId","EQ",a.getObject().EmailId);this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Students","GET",{filters:[r]},i,this).then(function(e){if(e.results.length!=0){sap.ui.getCore().byId("idEmailCust").setValue(e.results[0].GmailId);sap.ui.getCore().byId("idName").setValue(e.results[0].Name);if(e.results[0].ContactNo){sap.ui.getCore().byId("idPhone").setValue(e.results[0].ContactNo)}else{sap.ui.getCore().byId("idPhone").setValue(0)}if(e.results[0].Country){sap.ui.getCore().byId("idCountry").setSelectedKey(e.results[0].Country)}else{sap.ui.getCore().byId("idCountry").setSelectedKey("IN")}if(e.results[0].OtherEmail1){sap.ui.getCore().byId("idOtherEmail1").setValue(e.results[0].OtherEmail1)}if(e.results[0].OtherEmail2){sap.ui.getCore().byId("idOtherEmail2").setValue(e.results[0].OtherEmail2)}if(e.results[0].Defaulter){sap.ui.getCore().byId("idDefaulter").setSelected(e.results[0].Defaulter)}if(e.results[0].HighServerUsage){sap.ui.getCore().byId("idHighServerUsage").setSelected(e.results[0].HighServerUsage)}if(e.results[0].Star){sap.ui.getCore().byId("idStar").setSelected(e.results[0].Star)}sap.ui.getCore().byId("createNew").setText("Update");s.UpdateCustomer=true;s.customerGUID=e.results[0].id}else{var t;var i;sap.ui.getCore().byId("idEmailCust").setValue(a.getObject().EmailId);if(a.getObject().FirstName){if(a.getObject().LastName){t=a.getObject().LastName}else{t=" "}sap.ui.getCore().byId("idName").setValue(a.getObject().FirstName+" "+t)}else{i="";if(a.getObject().LastName){t=a.getObject().LastName}else{t=""}sap.ui.getCore().byId("idName").setValue(i+" "+t)}if(a.getObject().Phone){sap.ui.getCore().byId("idPhone").setValue(a.getObject().Phone)}else{sap.ui.getCore().byId("idPhone").setValue(0)}if(a.getObject().Country){sap.ui.getCore().byId("idCountry").setSelectedKey(a.getObject().Country)}else{sap.ui.getCore().byId("idCountry").setSelectedKey("IN")}sap.ui.getCore().byId("createNew").setText("Create");s.UpdateCustomer=false}}).catch(function(e){var t;var i;sap.ui.getCore().byId("idEmailCust").setValue(a.getObject().EmailId);if(a.getObject().FirstName){if(a.getObject().LastName){t=a.getObject().LastName}else{t=" "}sap.ui.getCore().byId("idName").setValue(a.getObject().FirstName+" "+t)}else{i="";if(a.getObject().LastName){t=a.getObject().LastName}else{t=""}sap.ui.getCore().byId("idName").setValue(i+" "+t)}if(a.getObject().Phone){sap.ui.getCore().byId("idPhone").setValue(a.getObject().Phone)}else{sap.ui.getCore().byId("idPhone").setValue(0)}if(a.getObject().Country){sap.ui.getCore().byId("idCountry").setSelectedKey(a.getObject().Country)}else{sap.ui.getCore().byId("idCountry").setSelectedKey("IN")}sap.ui.getCore().byId("createNew").setText("Create");s.UpdateCustomer=false})}},onAmountChange:function(e){var t=parseInt(e.getParameter("value"));if(t<CourseFee){var a=CourseFee-t;this.getView().getModel("local").setProperty("/newRegistration/PendingAmount",a);this.getView().getModel("local").setProperty("/newRegistration/PartialPayment",true)}else{this.getView().getModel("local").setProperty("/newRegistration/PendingAmount",0);this.getView().getModel("local").setProperty("/newRegistration/PartialPayment",false)}},onWaiver:function(e){var t=e.getParameter("selected");if(t===true){this.getView().getModel("local").setProperty("/newRegistration/PendingAmount",0);this.getView().getModel("local").setProperty("/newRegistration/PartialPayment",false)}else{var a=this.getView().getModel("local").getProperty("/newRegistration/Amount");if(a<CourseFee){var s=CourseFee-a;this.getView().getModel("local").setProperty("/newRegistration/PendingAmount",s);this.getView().getModel("local").setProperty("/newRegistration/PartialPayment",true)}else{this.getView().getModel("local").setProperty("/newRegistration/PendingAmount",0);this.getView().getModel("local").setProperty("/newRegistration/PartialPayment",false)}}},onSearch:function(e){if(this.sId.indexOf("customerId")!==-1){var t=this.getQuery(e);if(t){var a=new sap.ui.model.Filter("Name",sap.ui.model.FilterOperator.Contains,t);var s=new sap.ui.model.Filter("GmailId",sap.ui.model.FilterOperator.Contains,t);var i=new sap.ui.model.Filter({filters:[a,s],and:false});var r=[i];this.searchPopup.getBinding("items").filter(r)}else{this.searchPopup.bindAggregation("items",{path:"/Wards",template:new sap.m.ObjectListItem({title:"{Name}",intro:"{SchoolName}",number:"{RollNo}"})});this.searchPopup.getBinding("items").filter([])}}else if(this.sId.indexOf("courseId")!==-1){var t=this.getQuery(e);if(t){var a=new sap.ui.model.Filter("Name",sap.ui.model.FilterOperator.Contains,t);var s=new sap.ui.model.Filter("BatchNo",sap.ui.model.FilterOperator.Contains,t);var i=new sap.ui.model.Filter({filters:[a,s],and:false});var r=[i];this.searchPopup.getBinding("items").filter(r)}else{this.searchPopup.bindAggregation("items",{path:"/Courses",template:new sap.m.DisplayListItem({label:"{Name}",value:"{BatchNo}"})});this.searchPopup.getBinding("items").filter([])}}},onCancel:function(e){this.searchPopup.close()},onClose:function(){this.oSuppPopup.close()},onCreateCust:function(e){var t=e;var a=this;a.getView().setBusy(true);var s=this.getView().getModel("local").getProperty("/newCustomer");var i=sap.ui.getCore().byId("idFileUploader");var r=i.getFocusDomRef();var o=r.files[0];if(o){var a=this;var l=o.name.split(".");var n=l.length;var u=o.type.split("/")[1];var g=l[n-1];if(g=="PDF"||g=="DOCX"||g=="DOC"||g=="pdf"||g=="docx"||g=="doc"||g=="msword"||g=="MSWORD"){var d=new FileReader;d.onload=function(e){if(g=="PDF"||g=="pdf"){a.FileContent=e.currentTarget.result.replace("data:application/pdf;base64,","")}else{if(u=="msword"){a.FileContent=e.currentTarget.result.replace("data:application/msword;base64,","")}else{a.FileContent=e.currentTarget.result.replace("data:application/vnd.openxmlformats-officedocument.wordprocessingml.document;base64,","")}}};d.readAsDataURL(o)}else{sap.m.MessageToast.show("File Type should be PDF or DOC");return""}}if(a.UpdateCustomer==false){var p={GmailId:s.GmailId,Name:s.Name,CompanyMail:s.CompanyMail,Country:s.Country,Designation:s.Designation,OtherEmail1:s.OtherEmail1,OtherEmail2:s.OtherEmail2,ContactNo:s.ContactNo,Star:s.Star,Defaulter:s.Defaulter,HighServerUsage:s.HighServerUsage,Skills:s.Skills,Resume:this.FileContent,Extra1:"EExtra1",Extra2:"EExtra2",CreatedOn:new Date,CreatedBy:"DemoUser"};this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Students","POST",{},p,this).then(function(e){a.getView().setBusy(false);sap.m.MessageToast.show("Customer Saved successfully");a.destroyMessagePopover();a.oSuppPopup.close()}).catch(function(e){a.getView().setBusy(false);var t=a.getErrorMessage(e)})}else{var c=" ";if(s.Star==true){c="true"}else{c="false"}var m=" ";if(s.Defaulter==true){m="true"}else{m="false"}var h=" ";if(s.HighServerUsage==true){h="true"}else{h="false"}var p={GmailId:s.GmailId,Name:s.Name,CompanyMail:s.CompanyMail,Country:s.Country,Designation:s.Designation,OtherEmail1:s.OtherEmail1,OtherEmail2:s.OtherEmail2,ContactNo:s.ContactNo,Star:c,Defaulter:m,HighServerUsage:h,Skills:s.Skills,Resume:this.FileContent,Extra1:"EExtra1",Extra2:"EExtra2",ChangedOn:new Date,ChangedBy:"DemoUser"};var f="/Students";f=f+"("+"'"+a.customerGUID+"'"+")";this.ODataHelper.callOData(this.getOwnerComponent().getModel(),f,"PUT",{},p,this).then(function(e){a.getView().setBusy(false);sap.m.MessageToast.show("Customer updated successfully");a.destroyMessagePopover();a.oSuppPopup.close()}).catch(function(e){a.getView().setBusy(false);var t=a.getErrorMessage(e)})}},onLiveSearch:function(e){var t=e.getParameter("query");if(!t){t=e.getParameter("value")}if(this.sId.indexOf("customerId")!==-1){if(t){var a=new sap.ui.model.Filter("Name",sap.ui.model.FilterOperator.Contains,t);var s=new sap.ui.model.Filter("SchoolName",sap.ui.model.FilterOperator.Contains,t);var i=new sap.ui.model.Filter({filters:[a,s],and:false});var r=[i];this.searchPopup.getBinding("items").filter(r)}else{this.searchPopup.bindAggregation("items",{path:"/Wards",template:new sap.m.ObjectListItem({title:"{Name}",intro:"{SchoolName}",number:"{RollNo}"})});this.searchPopup.getBinding("items").filter([])}}else if(this.sId.indexOf("courseId")!==-1){if(t){var a=new sap.ui.model.Filter("Name",sap.ui.model.FilterOperator.Contains,t);var s=new sap.ui.model.Filter("BatchNo",sap.ui.model.FilterOperator.Contains,t);var i=new sap.ui.model.Filter({filters:[a,s],and:false});var r=[i];this.searchPopup.getBinding("items").filter(r)}else{this.searchPopup.bindAggregation("items",{path:"/Courses",template:new sap.m.DisplayListItem({label:"{Name}",value:"{BatchNo}"})});this.searchPopup.getBinding("items").filter([])}}else if(this.sId.indexOf("accountDetails")!==-1){if(t){var a=new sap.ui.model.Filter("value",sap.ui.model.FilterOperator.Contains,t);var s=new sap.ui.model.Filter("key",sap.ui.model.FilterOperator.Contains,t);var i=new sap.ui.model.Filter({filters:[a,s],and:false});var r=[i];this.searchPopup.getBinding("items").filter(r)}else{this.searchPopup.bindAggregation("items",{path:"local>/accountSet",template:new sap.m.DisplayListItem({label:"{local>value}",value:"{local>key}"})});this.searchPopup.getBinding("items").filter([])}}else if(this.sId.indexOf("idEmailCust")!==-1){if(t){var a=new sap.ui.model.Filter("EmailId",sap.ui.model.FilterOperator.Contains,t);var s=new sap.ui.model.Filter("FirstName",sap.ui.model.FilterOperator.Contains,t);var i=new sap.ui.model.Filter({filters:[a,s],and:false});var r=[i];this.searchPopup.getBinding("items").filter(r)}else{this.searchPopup.bindAggregation("items",{path:"/Inquries",template:new sap.m.DisplayListItem({label:"{EmailId}",value:"{FirstName}"})});this.searchPopup.getBinding("items").filter([])}}},onClearScreen:function(e){this.getView().getModel("local").setProperty("/newRegistration/StartDate",this.formatter.getFormattedDate(0));this.getView().getModel("local").setProperty("/newRegistration/PaymentDate",this.formatter.getFormattedDate(0));this.getView().getModel("local").setProperty("/newRegistration/PaymentDueDate",this.formatter.getFormattedDate(1));this.getView().getModel("local").setProperty("/newRegistration/StudentId",null);this.getView().getModel("local").setProperty("/newRegistration/CourseId",null);this.getView().getModel("local").setProperty("/newRegistration/Mode","L");this.getView().getModel("local").setProperty("/newRegistration/PaymentMode","IMPS");this.getView().getModel("local").setProperty("/newRegistration/AccountName",null);this.getView().getModel("local").setProperty("/newRegistration/Amount",15e3);this.getView().getModel("local").setProperty("/newRegistration/PendingAmount",0);this.getView().getModel("local").setProperty("/newRegistration/PartialPayment",false);this.getView().getModel("local").setProperty("/newRegistration/Reference",null);this.getView().getModel("local").setProperty("/newRegistration/Extra2",null);this.getView().getModel("local").setProperty("/newRegistration/Waiver",false);this.getView().getModel("local").setProperty("/newRegistration/Waiver",false);this.getView().getModel("local").setProperty("/newRegistration/Waiver",false);this.getView().getModel("local").setProperty("/newCustomer/GmailId",null);this.getView().getModel("local").setProperty("/newCustomer/Name",null);this.getView().getModel("local").setProperty("/newCustomer/Country","IN");this.getView().getModel("local").setProperty("/newCustomer/ContactNo",null);this.getView().getModel("local").setProperty("/newCustomer/OtherEmail1",null);this.getView().getModel("local").setProperty("/newCustomer/OtherEmail2",null);this.getView().getModel("local").setProperty("/newCustomer/Skills",null);this.getView().getModel("local").setProperty("/newCustomer/Star",false);this.getView().getModel("local").setProperty("/newCustomer/Defaulter",false)},handleSkillChange:function(e){},handleSkillFinish:function(e){var t=e.getParameter("selectedItems");var a=" ";for(var s=0;s<t.length;s++){a+=t[s].getText();if(s!=t.length-1){a+=","}}this.getView().getModel("local").setProperty("/newCustomer/Skills",a)},onEmail:function(e){sap.ui.getCore().byId("idName").setEnabled(true)},onEmailExist:function(e){var t=e;var a=this;var s=this.getView().getModel("local").getProperty("/newCustomer");var i={};if(s.GmailId){var r=new sap.ui.model.Filter("GmailId","EQ",s.GmailId);this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Students","GET",{filters:[r]},i,this).then(function(e){if(e.results.length!=0){sap.ui.getCore().byId("createNew").setText("Update");a.UpdateCustomer=true;a.customerGUID=e.results[0].id;sap.m.MessageToast.show("Email Exists. Use F4 help or Use suggestion on Email field to fetch values")}else{sap.ui.getCore().byId("createNew").setText("Create");a.UpdateCustomer=false}}).catch(function(e){sap.m.MessageToast.show("New Customer");sap.ui.getCore().byId("createNew").setText("Create");a.UpdateCustomer=false})}else{sap.ui.getCore().byId("idName").setEnabled(false);sap.m.MessageToast.show("Enter/select email id first")}},onEnter:function(e){vEmail=e.getParameters().value;var t=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;sap.ui.getCore().byId("idSkills").clearSelection();sap.ui.getCore().byId("idPhone").setValue(0);sap.ui.getCore().byId("idCountry").setSelectedKey("IN");sap.ui.getCore().byId("idOtherEmail1").setValue(null);sap.ui.getCore().byId("idOtherEmail2").setValue(null);sap.ui.getCore().byId("idStar").setSelected(false);sap.ui.getCore().byId("idName").setValue(null);sap.ui.getCore().byId("idDefaulter").setSelected(false);sap.ui.getCore().byId("idHighServerUsage").setSelected(false);if(t.test(vEmail)){var a=this;var s={};var i=new sap.ui.model.Filter("GmailId","EQ",vEmail);this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Students","GET",{filters:[i]},s,this).then(function(e){if(e.results.length!=0){sap.ui.getCore().byId("idEmailCust").setValue(e.results[0].GmailId);sap.ui.getCore().byId("idName").setValue(e.results[0].Name);if(e.results[0].ContactNo){sap.ui.getCore().byId("idPhone").setValue(e.results[0].ContactNo)}else{sap.ui.getCore().byId("idPhone").setValue(0)}if(e.results[0].Country){sap.ui.getCore().byId("idCountry").setSelectedKey(e.results[0].Country)}else{sap.ui.getCore().byId("idCountry").setSelectedKey("IN")}if(e.results[0].OtherEmail1){sap.ui.getCore().byId("idOtherEmail1").setValue(e.results[0].OtherEmail1)}if(e.results[0].OtherEmail2){sap.ui.getCore().byId("idOtherEmail2").setValue(e.results[0].OtherEmail2)}if(e.results[0].Defaulter){sap.ui.getCore().byId("idDefaulter").setSelected(e.results[0].Defaulter)}if(e.results[0].HighServerUsage){sap.ui.getCore().byId("idHighServerUsage").setSelected(e.results[0].HighServerUsage)}if(e.results[0].Star){sap.ui.getCore().byId("idStar").setSelected(e.results[0].Star)}sap.ui.getCore().byId("createNew").setText("Update");a.UpdateCustomer=true;a.customerGUID=e.results[0].id}else{var t;var s;var i=a;var r={};var o=new sap.ui.model.Filter("EmailId","EQ",a.vEmail);a.ODataHelper.callOData(a.getOwnerComponent().getModel(),"/Inquries","GET",{filters:[o]},r,a).then(function(e){if(e.results.length!=0){sap.ui.getCore().byId("idEmailCust").setValue(e.results[0].EmailId);sap.ui.getCore().byId("idName").setValue(e.results[0].Name);if(e.results[0].FirstName){if(e.results[0].LastName){t=e.results[0].LastName}else{t=" "}sap.ui.getCore().byId("idName").setValue(e.results[0].FirstName+" "+t)}else{s="";if(e.results[0].LastName){t=e.results[0].LastName}else{t=""}sap.ui.getCore().byId("idName").setValue(s+" "+t)}if(e.results[0].Phone){sap.ui.getCore().byId("idPhone").setValue(e.results[0].Phone)}else{sap.ui.getCore().byId("idPhone").setValue(0)}if(e.results[0].Country){sap.ui.getCore().byId("idCountry").setSelectedKey(e.results[0].Country)}else{sap.ui.getCore().byId("idCountry").setSelectedKey("IN")}sap.ui.getCore().byId("createNew").setText("Create");i.UpdateCustomer=false}else{sap.ui.getCore().byId("createNew").setText("Create");i.UpdateCustomer=false}}).catch(function(e){var t=i.getErrorMessage(e)})}}).catch(function(e){var t=a.getErrorMessage(e)})}else{sap.m.MessageToast.show("Invalid email id");return""}},onStudentLinkPress:function(e){var t=this;this.oStudentId=e.getSource().getBindingContext().getObject().StudentId;var a="/Wards('"+this.oStudentId+"')/ToInquiry";this.ODataHelper.callOData(this.getOwnerComponent().getModel(),a,"GET",null,null,this).then(function(e){t.getView().getModel("local").setProperty("/parentDetails",e)}).catch(function(e){});var s=e.getSource(),i=this.getView();if(!this._oPopover){this._oPopover=l.load({name:"oft.fiori.fragments.UserMenu",controller:this}).then(function(e){i.addDependent(e);return e})}this._oPopover.then(function(e){e.openBy(s)})},onExportExcel:function(){$.ajax({type:"GET",url:"getAllData",success:function(e){debugger;if(e.length>0){var t=e[0];var a=[];for(const e in t){a.push({label:e,property:[e]})}}var s,i,r,o,l;i=e;s=a;r={workbook:{columns:s,hierarchyLevel:"Level"},dataSource:i,fileName:"Data_"+(new Date).toISOString()+".xlsx",worker:false};o=new n(r);o.build().finally(function(){o.destroy()})},error:function(e,t,s){console.error(s);a.show("Error sending OTP via email")}})},onTransDataExport:function(e){var t=[];var a=this.getModel("appView").getProperty("/U_ENT_CPRT_POS_TRANS");var s=this.getModel("appView").getProperty("/TransColumn");for(const e in s){if(Object.hasOwnProperty.call(s,e)){const s=a[0][e];t.push({label:e.includes("U_")?e.split("U_")[1]:e,property:[e],type:typeof s==="number"?EdmType.Number:EdmType.String})}}var i,r,o,l,u;if(!this._oTable){this._oTable=this.byId("transationTable")}u=this._oTable;r=u.getBinding("rows");i=t;o={workbook:{columns:i,hierarchyLevel:"Level"},dataSource:r,fileName:"Data_"+(new Date).toISOString()+".xlsx",worker:false};l=new n(o);l.build().finally(function(){l.destroy()})}})});