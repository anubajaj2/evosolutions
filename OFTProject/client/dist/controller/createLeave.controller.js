sap.ui.define(["oft/fiori/controller/BaseController","sap/m/MessageBox","sap/m/MessageToast","oft/fiori/models/formatter","sap/ui/model/Filter"],function(e,t,a,s,l){"use strict";return e.extend("oft.fiori.controller.createLeave",{formatter:s,onInit:function(){this.oRouter=sap.ui.core.UIComponent.getRouterFor(this);this.oRouter.attachRoutePatternMatched(this.herculis,this);var e=new Date;this.getModel("local").setProperty("/LeaveStatic/dateValueDRS1",this.startDate);this.getModel("local").setProperty("/LeaveStatic/secondDateValueDRS1",this.startDate);this.getModel("local").setProperty("/newLeaveRequest/DateFrom",this.formatter.getFormattedDate(0));this.getView().byId("idDPlblday").setVisible(false);this.getView().byId("idDatePicker").setVisible(false);var t=new Date;var a=this.getModel("local").getProperty("/CurrentUser");if(a){var s=this.getModel("local").oData.AppUsers[a].UserName;this.getView().byId("idUser").setText(s)}this.getView().byId("idSave").setEnabled(false)},onSelchange:function(e){var t=e.getParameters("selectedItem");if(t.selectedItem.mProperties.key==="Full Day"){this.getView().byId("idlblday").setVisible(true);this.getView().byId("idDate").setVisible(true);this.getView().byId("idDPlblday").setVisible(false);this.getView().byId("idDatePicker").setVisible(false);this.getView().getModel("local").setProperty("/newLeaveRequest/Days",0)}else{this.getView().byId("idDPlblday").setVisible(true);this.getView().byId("idDatePicker").setVisible(true);this.getView().byId("idlblday").setVisible(false);this.getView().byId("idDate").setVisible(false);this.getView().getModel("local").setProperty("/newLeaveRequest/Days",.5);this.getView().getModel("local").setProperty("/newLeaveRequest/LeaveType","Half Day");this.getView().getModel("local").setProperty("/newLeaveRequest/DateFrom","")}},onBeforeRendering:function(){},onBack:function(){this.oRouter.navTo("leaveRequest")},herculis:function(e){this.reloadTasks()},reloadTasks:function(){var e=this.getModel("local").getProperty("/Role");var t=this.getModel("local").getProperty("/CurrentUser");var a=new Date;this.getView().byId("idCreateLeaveCalendar").setCurrentDate(a);var s={date:a,EmpId:t};$.post("/getLeaveValidator",s).done(this.successCallBack2.bind(this)).fail(function(e,t,a){sap.m.MessageBox.console.error("Something is wrong in your Code")})},successCallBack2:function(e,t){if(e.length){for(var a=0;a<e.length;a++){var s=e[a].Date;s=new Date(s);e[a].Date=s}var l=document.getElementById("__component0---idcreateLeave--idCreateLeaveCalendar").getElementsByClassName("sapMeCalendarMonthDay").length;for(var a=0;a<e.length;a++){var o=e[a].Date;for(var r=7;r<l;r++){var n=new Date(document.getElementById("__component0---idcreateLeave--idCreateLeaveCalendar").getElementsByClassName("sapMeCalendarMonthDay")[r].id.split("--")[2].split("idCreateLeaveCalendar-")[1]);if(o.getMonth()==n.getMonth()&&o.getDate()==n.getDate()&&o.getFullYear()==n.getFullYear()){if(e[a].Mark==="PH"){document.getElementById("__component0---idcreateLeave--idCreateLeaveCalendar").getElementsByClassName("sapMeCalendarMonthDay")[r].style.backgroundColor="#ffff4d"}else if(e[a].Holiday==="Holiday"){document.getElementById("__component0---idcreateLeave--idCreateLeaveCalendar").getElementsByClassName("sapMeCalendarMonthDay")[r].style.backgroundColor="#666699"}else if(e[a].Mark==="LEAVE"){if(e[a].LeaveType=="Full Day"){document.getElementById("__component0---idcreateLeave--idCreateLeaveCalendar").getElementsByClassName("sapMeCalendarMonthDay")[r].style.backgroundColor="#4d79ff"}else{document.getElementById("__component0---idcreateLeave--idCreateLeaveCalendar").getElementsByClassName("sapMeCalendarMonthDay")[r].style.backgroundColor="#4d79ff";document.getElementById("__component0---idcreateLeave--idCreateLeaveCalendar").getElementsByClassName("sapMeCalendarMonthDay")[r].style.borderLeftWidth="45px"}}}}}}else{sap.m.MessageToast.show("You Don't hava Data recorded for this Month")}},onChangeCurrentDate:function(e){setTimeout(this.afterCalChange.bind(this),1e3)},afterCalChange:function(){var e=this.getModel("local").getProperty("/CurrentUser");var t=new Date(this.getView().byId("idCreateLeaveCalendar").getCurrentDate());var a={date:t,EmpId:e};$.post("/getLeaveValidator",a).done(function(e,t){if(e.length){for(var a=0;a<e.length;a++){var s=e[a].Date;s=new Date(s);e[a].Date=s}var l=document.getElementById("__component0---idcreateLeave--idCreateLeaveCalendar").getElementsByClassName("sapMeCalendarMonthDay").length;for(var a=0;a<e.length;a++){var o=e[a].Date;for(var r=7;r<l;r++){var n=new Date(document.getElementById("__component0---idcreateLeave--idCreateLeaveCalendar").getElementsByClassName("sapMeCalendarMonthDay")[r].id.split("--")[2].split("idCreateLeaveCalendar-")[1]);if(o.getMonth()==n.getMonth()&&o.getDate()==n.getDate()&&o.getFullYear()==n.getFullYear()){if(e[a].Mark==="PH"){document.getElementById("__component0---idcreateLeave--idCreateLeaveCalendar").getElementsByClassName("sapMeCalendarMonthDay")[r].style.backgroundColor="#ffff4d";break}else if(e[a].Holiday==="Holiday"){document.getElementById("__component0---idcreateLeave--idCreateLeaveCalendar").getElementsByClassName("sapMeCalendarMonthDay")[r].style.backgroundColor="#666699";break}else if(e[a].Mark==="LEAVE"){if(e[a].LeaveType=="Full Day"){document.getElementById("__component0---idcreateLeave--idCreateLeaveCalendar").getElementsByClassName("sapMeCalendarMonthDay")[r].style.backgroundColor="#4d79ff"}else{document.getElementById("__component0---idcreateLeave--idCreateLeaveCalendar").getElementsByClassName("sapMeCalendarMonthDay")[r].style.backgroundColor="#4d79ff";document.getElementById("__component0---idcreateLeave--idCreateLeaveCalendar").getElementsByClassName("sapMeCalendarMonthDay")[r].style.borderLeftWidth="45px"}break}}}}}else{sap.m.MessageToast.show("You Don't hava Data recorded for this Month")}}).fail(function(e,t,a){sap.m.MessageBox.console.error("Something is wrong in your Code")})},onChangeRange:function(e){var t=this.getModel("local").getProperty("/CurrentUser");var a=new Date(e.getParameters().fromDate);var s={date:a,EmpId:t};var l=this;$.post("/getLeaveValidator",s).done(this.sparta.bind(this)).fail(function(e,t,a){sap.m.MessageBox.console.error("Something is wrong in your Code")})},sparta:function(e,t){if(e.length){for(var a=0;a<e.length;a++){e[a].Date=new Date(e[a].Date)}}var s=this.getView().byId("idlType").getSelectedKey();var l=new Date(this.getView().byId("idCreateLeaveCalendar").getSelectedDates()[0]);var o=new Date(this.getView().byId("idCreateLeaveCalendar").getSelectedDates()[this.getView().byId("idCreateLeaveCalendar").getSelectedDates().length-1]);if(l>o){sap.m.MessageBox.show("Please Select a valid Date Range...DateFrom can not be greater than DateTo",{onClose:this.onMessageBoxClose.bind(this)})}else if(l==null&&o==null){this.getView().byId("idSave").setEnabled(false)}var r=0;if(s==="Full Day"){this.getView().byId("idDate").setFrom(new Date(l));this.getView().byId("idDate").setTo(new Date(o));this.getView().getModel("local").setProperty("/newLeaveRequest/DateFrom",l);this.getView().getModel("local").setProperty("/newLeaveRequest/DateTo",o);if(l!=null&&o!=null){var n=o;var i=l;var d=(n-i)/(1e3*3600*24);var g=0;var D=0;for(var a=0;a<e.length;a++){if(l.getDate()==new Date(e[a].Date).getDate()&&l.getMonth()==new Date(e[a].Date).getMonth()&&l.getFullYear()==new Date(e[a].Date).getFullYear()){for(var h=0;h<d;h++){if(e[a].Mark=="PH"){g=g+1}else if(e[a].Holiday=="Holiday"){if(e[a].Mark!=="PH"){D=D+1}}a++}}}d=d-(g+D)+1;this.getView().getModel("local").setProperty("/newLeaveRequest/Days",d);for(var a=0;a<e.length;a++){if(e[a].Mark=="LEAVE"&&l.getDate()==new Date(e[a].Date).getDate()&&l.getMonth()==new Date(e[a].Date).getMonth()&&l.getFullYear()==new Date(e[a].Date).getFullYear()){sap.m.MessageBox.show("You have already applied leave for "+l.toDateString()+" Date,Please select another Date");this.getView().byId("idSave").setEnabled(false);r=1;break}else if(e[a].Mark=="LEAVE"&&o.getDate()==new Date(e[a].Date).getDate()&&o.getMonth()==new Date(e[a].Date).getMonth()&&o.getFullYear()==new Date(e[a].Date).getFullYear()){sap.m.MessageBox.show("You have already applied leave for "+o.toDateString()+" Date,Please select another Date");this.getView().byId("idSave").setEnabled(false);r=1;break}else if(e[a].Mark=="LEAVE"&&l<e[a].Date&&o>e[a].Date){sap.m.MessageBox.show("You have already applied leave in between Selected Range,Please Create two seperate leaves from "+l.toDateString()+" To "+e[a-1].Date.toDateString()+" and From "+e[a+1].Date.toDateString()+" To "+o.toDateString());this.getView().byId("idSave").setEnabled(false);r=1;break}else if(e[a].Mark=="PH"&&l.getDate()==new Date(e[a].Date).getDate()&&l.getMonth()==new Date(e[a].Date).getMonth()&&l.getFullYear()==new Date(e[a].Date).getFullYear()){sap.m.MessageBox.show("The Selected Date "+l.toDateString()+" is A public Holiday- "+e[a].Occasion+"- Please select another Date");this.getView().byId("idSave").setEnabled(false);r=1;break}else if(e[a].Mark=="PH"&&o.getDate()==new Date(e[a].Date).getDate()&&o.getMonth()==new Date(e[a].Date).getMonth()&&o.getFullYear()==new Date(e[a].Date).getFullYear()){sap.m.MessageBox.show("The Selected Date "+o.toDateString()+" is A public Holiday- "+e[a].Occasion+"- Please select another Date");this.getView().byId("idSave").setEnabled(false);r=1;break}else if(e[a].Holiday=="Holiday"&&l.getDate()==new Date(e[a].Date).getDate()&&l.getMonth()==new Date(e[a].Date).getMonth()&&l.getFullYear()==new Date(e[a].Date).getFullYear()){sap.m.MessageBox.show("The Selected Date "+l.toDateString()+" is a already a holiday for you, Please select another Date");this.getView().byId("idSave").setEnabled(false);r=1;break}else if(e[a].Holiday=="Holiday"&&o.getDate()==new Date(e[a].Date).getDate()&&o.getMonth()==new Date(e[a].Date).getMonth()&&o.getFullYear()==new Date(e[a].Date).getFullYear()){sap.m.MessageBox.show("The Selected Date "+o.toDateString()+" is a already a holiday for you, Please select another Date");this.getView().byId("idSave").setEnabled(false);r=1;break}}if(r==0){this.getView().byId("idSave").setEnabled(true)}else{this.getView().byId("idSave").setEnabled(false)}}else{this.getView().byId("idSave").setEnabled(false)}}else if(s=="Half Day"){var y=new Date(this.getView().byId("idCreateLeaveCalendar").getSelectedDates()[0]);this.getView().getModel("local").setProperty("/newLeaveRequest/Days",.5);this.getView().getModel("local").setProperty("/newLeaveRequest/LeaveType","Half Day");this.getView().getModel("local").setProperty("/newLeaveRequest/DateFrom",y);this.getView().byId("idDatePicker").setDateValue(new Date(y));this.getView().getModel("local").setProperty("/newLeaveRequest/DateTo",y);var r=0;if(y!=null){for(var a=0;a<e.length;a++){if(e[a].Mark=="LEAVE"&&y.getDate()==new Date(e[a].Date).getDate()&&y.getMonth()==new Date(e[a].Date).getMonth()&&y.getFullYear()==new Date(e[a].Date).getFullYear()){sap.m.MessageBox.show("You have already applied leave for "+y.toDateString()+" Date,Please select another Date");this.getView().byId("idSave").setEnabled(false);r=1;break}else if(e[a].Mark=="PH"&&y.getDate()==new Date(e[a].Date).getDate()&&y.getMonth()==new Date(e[a].Date).getMonth()&&y.getFullYear()==new Date(e[a].Date).getFullYear()){sap.m.MessageBox.show("The Selected Date "+y.toDateString()+" is A public Holiday- "+e[a].Occasion+"- Please select another Date");this.getView().byId("idSave").setEnabled(false);r=1;break}else if(e[a].Holiday=="Holiday"&&y.getDate()==new Date(e[a].Date).getDate()&&y.getMonth()==new Date(e[a].Date).getMonth()&&y.getFullYear()==new Date(e[a].Date).getFullYear()){sap.m.MessageBox.show("The Selected Date "+y.toDateString()+" is a already a holiday for you, Please select another Date");this.getView().byId("idSave").setEnabled(false);r=1;break}}if(r==0){this.getView().byId("idSave").setEnabled(true)}else{this.getView().byId("idSave").setEnabled(false)}}else{this.getView().byId("idSave").setEnabled(false)}}},onMessageBoxClose:function(e){this.getView().byId("idSave").setEnabled(false)},onhandleChange:function(e){this.callLeaveValidator();var t={};var a={};var s={};a=e.getParameter("from");var l=new Date(new Date(a).getFullYear(),new Date(a).getMonth(),new Date(a).getDate()+1);s=e.getParameter("to");var o=s-a;var r=o/(1e3*3600*24);r=r+1;if(r==0){this.getView().getModel("local").setProperty("/newLeaveRequest/Days",1)}else{this.getView().getModel("local").setProperty("/newLeaveRequest/Days",r)}var n=e.getParameter("valid");this.getView().getModel("local").setProperty("/newLeaveRequest/DateFrom",a);this.getView().getModel("local").setProperty("/newLeaveRequest/DateTo",s)},callLeaveValidator:function(){var e=this.getModel("local").getProperty("/CurrentUser");var t=new Date;var a={date:t,EmpId:e};$.post("/getLeaveValidator",a).done(this.successCallBack.bind(this)).fail(function(e,t,a){sap.m.MessageBox.console.error("Something is wrong in your Code")})},successCallBack:function(e,t){if(e.length){for(var a=0;a<e.length;a++){e[a].Date=new Date(e[a].Date)}}var s=this.getView().byId("idlType").getSelectedKey();var l=this.getView().byId("idDate").getFrom();var o=this.getView().byId("idDate").getTo();var r=0;if(s==="Full Day"){if(l!=null&&o!=null){var n=o;var i=l;var d=(n-i)/(1e3*3600*24);var g=0;var D=0;for(var a=0;a<e.length;a++){if(l.getDate()==new Date(e[a].Date).getDate()&&l.getMonth()==new Date(e[a].Date).getMonth()&&l.getFullYear()==new Date(e[a].Date).getFullYear()){for(var h=0;h<d;h++){if(e[a].Mark=="PH"){g=g+1}else if(e[a].Holiday=="Holiday"){if(e[a].Mark!=="PH"){D=D+1}}a++}}}d=d-(g+D)+1;this.getView().getModel("local").setProperty("/newLeaveRequest/Days",d);for(var a=0;a<e.length;a++){if(e[a].Mark=="LEAVE"&&l.getDate()==new Date(e[a].Date).getDate()&&l.getMonth()==new Date(e[a].Date).getMonth()&&l.getFullYear()==new Date(e[a].Date).getFullYear()){sap.m.MessageBox.show("You have already applied leave for "+l+" Date,Please select another Date");this.getView().byId("idSave").setEnabled(false);r=1;break}else if(e[a].Mark=="LEAVE"&&o.getDate()==new Date(e[a].Date).getDate()&&o.getMonth()==new Date(e[a].Date).getMonth()&&o.getFullYear()==new Date(e[a].Date).getFullYear()){sap.m.MessageBox.show("You have already applied leave for "+o+" Date,Please select another Date");this.getView().byId("idSave").setEnabled(false);r=1;break}else if(e[a].Mark=="LEAVE"&&l<e[a].Date&&o>e[a].Date){sap.m.MessageBox.show("You have already applied leave in between "+l.toLocaleDateString()+" and "+o.toLocaleDateString()+" , Please Create two seperate leaves from "+l.toLocaleDateString()+" To "+e[a-1].Date.toLocaleDateString()+" and From "+e[a+1].Date.toLocaleDateString()+" To "+o.toLocaleDateString());this.getView().byId("idSave").setEnabled(false);r=1;break}else if(e[a].Mark=="PH"&&l.getDate()==new Date(e[a].Date).getDate()&&l.getMonth()==new Date(e[a].Date).getMonth()&&l.getFullYear()==new Date(e[a].Date).getFullYear()){sap.m.MessageBox.show("The Selected Date "+l+" is A public Holiday- "+e[a].Occasion+"- Please select another Date");this.getView().byId("idSave").setEnabled(false);r=1;break}else if(e[a].Mark=="PH"&&o.getDate()==new Date(e[a].Date).getDate()&&o.getMonth()==new Date(e[a].Date).getMonth()&&o.getFullYear()==new Date(e[a].Date).getFullYear()){sap.m.MessageBox.show("The Selected Date "+o+" is A public Holiday- "+e[a].Occasion+"- Please select another Date");this.getView().byId("idSave").setEnabled(false);r=1;break}else if(e[a].Holiday=="Holiday"&&l.getDate()==new Date(e[a].Date).getDate()&&l.getMonth()==new Date(e[a].Date).getMonth()&&l.getFullYear()==new Date(e[a].Date).getFullYear()){sap.m.MessageBox.show("The Selected Date "+l+" is a already a holiday for you, Please select another Date");this.getView().byId("idSave").setEnabled(false);r=1;break}else if(e[a].Holiday=="Holiday"&&o.getDate()==new Date(e[a].Date).getDate()&&o.getMonth()==new Date(e[a].Date).getMonth()&&o.getFullYear()==new Date(e[a].Date).getFullYear()){sap.m.MessageBox.show("The Selected Date "+o+" is a already a holiday for you, Please select another Date");this.getView().byId("idSave").setEnabled(false);r=1;break}}if(r==0){this.getView().byId("idSave").setEnabled(true)}else{this.getView().byId("idSave").setEnabled(false)}}else{this.getView().byId("idSave").setEnabled(false)}}else if(s=="Half Day"){var y=this.getView().byId("idDatePicker").getDateValue();var r=0;if(y!=null){for(var a=0;a<e.length;a++){if(e[a].Mark=="LEAVE"&&y.getDate()==new Date(e[a].Date).getDate()&&y.getMonth()==new Date(e[a].Date).getMonth()&&y.getFullYear()==new Date(e[a].Date).getFullYear()){sap.m.MessageBox.show("You have already applied leave for "+y+" Date,Please select another Date");this.getView().byId("idSave").setEnabled(false);r=1;break}else if(e[a].Mark=="PH"&&y.getDate()==new Date(e[a].Date).getDate()&&y.getMonth()==new Date(e[a].Date).getMonth()&&y.getFullYear()==new Date(e[a].Date).getFullYear()){sap.m.MessageBox.show("The Selected Date "+y+" is A public Holiday- "+e[a].Occasion+"- Please select another Date");this.getView().byId("idSave").setEnabled(false);r=1;break}else if(e[a].Holiday=="Holiday"&&y.getDate()==new Date(e[a].Date).getDate()&&y.getMonth()==new Date(e[a].Date).getMonth()&&y.getFullYear()==new Date(e[a].Date).getFullYear()){sap.m.MessageBox.show("The Selected Date "+y+" is a already a holiday for you, Please select another Date");this.getView().byId("idSave").setEnabled(false);r=1;break}}if(r==0){this.getView().byId("idSave").setEnabled(true)}else{this.getView().byId("idSave").setEnabled(false)}}else{this.getView().byId("idSave").setEnabled(false)}}},onDPhandleChange:function(e){this.callLeaveValidator();var t=e.getSource();var a=e.getParameter("value");var s=e.getParameter("valid");this.getView().getModel("local").setProperty("/newLeaveRequest/Days",.5);this.getView().getModel("local").setProperty("/newLeaveRequest/DateFrom",a);this.getView().getModel("local").setProperty("/newLeaveRequest/DateTo",a)},onCancel:function(e){this.getView().getModel("local").setProperty("/newLeaveRequest/DateFrom",this.formatter.getFormattedDate(0));this.getView().getModel("local").setProperty("/newLeaveRequest/DateTo",this.formatter.getFormattedDate(0));this.getView().getModel("local").setProperty("/newLeaveRequest/Remarks",null)},onSave:function(e){var a=e;var s=this;var l=this;s.getView().setBusy(true);var o=this.getModel("local").getProperty("/CurrentUser");var r=this.getView().getModel("local").getProperty("/newLeaveRequest");var n=this.getView().getModel("local").getProperty("/LeaveStatic");if(r.DateFrom>r.DateTo){s.getView().setBusy(false);sap.m.MessageBox.error("Date From Cannot be greater than Date To");return}var i=new Date(r.DateFrom);var d=i.getFullYear();i=new Date(r.DateTo);var g=i.getFullYear();if(d!=g){s.getView().setBusy(false);sap.m.MessageBox.error("Please do not span leaves over multiple years");return}if(r.Days>n.Available){t.confirm("Do you want to proceed with leave Creation ?",function(e){if(e=="OK"){var t={AppUserId:o,DateFrom:r.DateFrom,DateTo:r.DateTo,Days:r.Days,LeaveType:r.LeaveType,Status:"Not Approved",ApproverId:"",ApprovedOn:new Date,RequestedOn:new Date,Remarks:r.Remarks,ChangedOn:new Date,ChangedBy:o};var a=l;l.ODataHelper.callOData(l.getOwnerComponent().getModel(),"/LeaveRequests","POST",{},t,l).then(function(e){s.getView().setBusy(false);sap.m.MessageToast.show("Leave Request send for Approval");var l=a.getModel("local").getProperty("/UserName");var o=a.getModel("local").getProperty("/MobileNo");var r={};r.msgType="leaveRequest";r.userName=l;r.requested=t.Days;r.balance="?";r.Number=o;$.post("/requestMessage",r).done(function(e,t){sap.m.MessageToast.show("Message sent successfully")}).fail(function(e,t,a){s.passwords="";sap.m.MessageBox.error(e.responseText)});s.destroyMessagePopover()}).catch(function(e){s.getView().setBusy(false);var t=s.getErrorMessage(e)})}else{s.getView().setBusy(false)}},"Confirmation")}else{var D={AppUserId:o,DateFrom:r.DateFrom,DateTo:r.DateTo,Days:r.Days,LeaveType:r.LeaveType,Status:"Not Approved",ApproverId:"",ApprovedOn:new Date,RequestedOn:new Date,Remarks:r.Remarks,ChangedOn:new Date,ChangedBy:o};this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/LeaveRequests","POST",{},D,this).then(function(e){s.getView().setBusy(false);sap.m.MessageToast.show("Leave Request send for Approval");var t=l.getModel("local").getProperty("/UserName");var a=l.getModel("local").getProperty("/MobileNo");var o={};o.msgType="leaveRequest";o.userName=t;o.requested=D.Days;o.balance="?";o.Number=a;$.post("/requestMessage",o).done(function(e,t){sap.m.MessageToast.show("Message sent successfully")}).fail(function(e,t,a){s.passwords="";sap.m.MessageBox.error(e.responseText)});s.destroyMessagePopover()}).catch(function(e){s.getView().setBusy(false);var t=s.getErrorMessage(e)})}}})});