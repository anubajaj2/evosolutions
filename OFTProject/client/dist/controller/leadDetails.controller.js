sap.ui.define(["oft/fiori/controller/BaseController","sap/m/MessageToast","sap/ui/core/Fragment","sap/m/Image"],function(e,t,r,o){"use strict";return e.extend("oft.fiori.controller.leadDetails",{onInit:function(){var e=this.getOwnerComponent().getRouter();e.attachRouteMatched(this._onRouteMatched,this);this.emailCount=0},_onRouteMatched:function(e){var t=e.getParameter("name");setTimeout(()=>{if(t==="leadDetails"){this.getView().getModel("local").setProperty("/onResendOTP",false);this.getView().getModel("local").setProperty("/sendOtp",true);this.getView().getModel("local").setProperty("/otpVisible",false);this.getView().getModel("local").setProperty("/PageVisibility",false);this.getView().getModel("local").setProperty("/verifySubmit",false);this.getView().getModel("local").setProperty("/Email","");this.getView().getModel("local").setProperty("/captcha","");this.getView().getModel("local").setProperty("/otpValue","");this.getView().getModel("local").setProperty("/sendOtpDisabled",true);this.onOpenDialog();this.getView().getModel("local").updateBindings();this.getView().getModel("local").refresh()}},1500)},onOpenDialog:function(){var e=this.getView();var t=this;if(!this.oDialog){this.oDialog=r.load({id:e.getId(),name:"oft.fiori.fragments.leadDetails",controller:this}).then(function(r){e.addDependent(r);t.onCaptchaGenerate();return r}.bind(this))}this.oDialog.then(function(e){t.getView().getModel("local").setProperty("/numberVisible",false);t.getView().getModel("local").setProperty("/messageStripVisible",false);t.getView().getModel("local").setProperty("/onResendOTP",false);t.getView().getModel("local").setProperty("/otpVisible",false);t.getView().getModel("local").setProperty("/PageVisibility",false);t.getView().getModel("local").setProperty("/verifySubmit",false);e.open();t.onRefresh();this.getView().getModel("local").refresh()})},onCaptchaGenerate:function(){var e=this;var t="";var r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var l=0;l<6;l++){t+=r.charAt(Math.floor(Math.random()*r.length))}var i=document.createElement("canvas");i.width=100;i.height=30;var a=i.getContext("2d");a.fillText(t,20,20);var s=new o({src:i.toDataURL(),width:"150%",height:"150%"});var n=e.getView().byId("idLead");n.addItem(s);this._captchaCode=t},numberValidation:function(e){var r=e;if(r.length!==10||isNaN(r)){t.show("Invalid Mobile Number");return false}else{return true}},validateCaptcha:function(){var e=this.getView().getModel("local").getProperty("/Email");this.sEmail=this.getView().getModel("local").getProperty("/Email");var r=this.getView().getModel("local").getProperty("/captcha");var o=/^\w+[\w-+\.]*\@\w+([-\.]\w+)*\.[a-zA-Z]{2,}$/;if(!e){t.show("Please enter a valid email address.");return}else{this.getView().getModel("local").setProperty("/email",false)}if(e&&!e.match(o)){t.show("Please enter a valid email address.");return}if(!r||r!==this._captchaCode){t.show("Please enter a valid captcha code.");return}var l=this;var i=this.getView().getModel("local");var l=this;var i=this.getView().getModel("local");$.ajax({type:"POST",url:"sendOtpViaEmail",data:{eMail:e},success:function(e){if(e=="email sent"){i.setProperty("/sendOtpDisabled",false)}i.setProperty("/otpVisible",true);i.setProperty("/sendOtp",false);t.show("OTP Successfully Sent To Your Mail.")},error:function(e,r,o){console.error(o);t.show("Error sending OTP via email")}});this.OtpSend()},onNumberCaptchaCheck:function(){var e=this.getView().getModel("local").getProperty("/captcha");if(!e||e!==this._captchaCode){t.show("Please enter a valid captcha code.");return false}else{return true}},resendOTP:function(){this.getView().getModel("local").setProperty("/sendOtp",false);var e=this.getView().getModel("local").getProperty("/Email");this.sEmail=this.getView().getModel("local").getProperty("/Email");var r=this.getView().getModel("local").getProperty("/captcha");var o=/^\w+[\w-+\.]*\@\w+([-\.]\w+)*\.[a-zA-Z]{2,}$/;if(!e){t.show("Please enter a valid email address.");return}else{this.getView().getModel("local").setProperty("/EmailEditable",false)}if(e&&!e.match(o)){t.show("Please enter a valid email address.");return}if(!r||r!==this._captchaCode){t.show("Please enter a valid captcha code.");return}var l=this;var i=this.getView().getModel("local");var l=this;var i=this.getView().getModel("local");$.ajax({type:"POST",url:"sendOtpViaEmail",data:{eMail:e},success:function(e){if(e=="email sent"){i.setProperty("/sendOtpDisabled",false)}i.setProperty("/otpVisible",true);i.setProperty("/sendOtp",false);i.setProperty("/captcha","");t.show("OTP Successfully Sent To Your Mail.")},error:function(e,r,o){console.error(o);t.show("Error sending OTP via email")}});this.OtpReSend()},onNumberOTPPress:function(){var e=this;var r=this.getView().getModel("local").getProperty("/mobileNumber");var o=this.onNumberCaptchaCheck();if(r){this.MobileNumber=this.getView().getModel("local").getProperty("/mobileNumber");var l=this.numberValidation(r);if(l&&o){this.getView().getModel("local").setProperty("/MobileNumber",false);$.ajax({type:"POST",url:"requestMessage",data:{Number:r,msgType:"OTP"},success:function(r){e.getView().getModel("local").setProperty("/otpVisible",true);t.show("OTP Successfully Sent")},error:function(e,r,o){console.error(o);t.show("Error sending OTP via email")}})}}else{t.show("Please Enter A Valid Mobile Number")}},onSubmit:function(){var e=this.getView().getModel("local").getProperty("/numberVisible");if(e){this.sEmail=this.MobileNumber}var r=this;this.emailCount+=1;var o=this.getView().getModel("local");var l=o.getProperty("/otpValue");debugger;if(l!==undefined){var r=this;$.ajax({type:"GET",url:"validateOtp",data:{email:this.sEmail,OTP:l},success:function(e){if(e===false){t.show("Error in Verification");o.setProperty("/otpValue","");r.onRefresh();o.setProperty("/captcha","")}else{r.getView().getModel("local").setProperty("/Authorization",e.id);r.getView().getModel().setHeaders({Authorization:e.id});r.secureToken=e.id;r.getView().getModel("local").setProperty("/CurrentUser",e.userId);r.getView().getModel().setUseBatch(false);var l=r;var i=[new sap.ui.model.Filter("TechnicalId",sap.ui.model.FilterOperator.EQ,e.userId)];var a={filters:i};var s=false;var n=[];r.ODataHelper.callOData(r.getOwnerComponent().getModel(),"/AppUsers","GET",{},{},r).then(function(t){var r=[];if(t.results.length!=0){for(var o=0;o<t.results.length;o++){n[t.results[o].TechnicalId]=t.results[o];if(t.results[o].TechnicalId===e.userId){l.getView().getModel("local").setProperty("/Role",t.results[o].Role);l.getView().getModel("local").setProperty("/UserName",t.results[o].UserName);l.getView().getModel("local").setProperty("/JoiningDate",t.results[o].JoiningDate);l.getView().getModel("local").setProperty("/LeaveQuota",t.results[o].LeaveQuota);l.getView().getModel("local").setProperty("/MobileNo",t.results[o].MobileNo);s=true}else{l.getView().getModel("local").setProperty("/Authorization","");r.push(t.results[o])}}if(s===true){l.getView().getModel("local").setProperty("/AppUsers",n);l.getView().getModel("local").setProperty("/AppUsersCopy",r);l.oDialog.then(function(e){e.close()});l.getRouter().navTo("leadDetail")}else{sap.m.MessageBox.error("The user is not authorized, Contact Anubhav")}}}).catch(function(e){t.show("Error While Login")})}},error:function(e,r,o){console.error(o);t.show("Error in Verification")}})}else{t.show("Please Enter Your  OTP")}},onEnter:function(){var e=this.getView().getModel("local").getProperty("/emailVisible");if(e==false){this.onNumberOTPPress()}else{this.validateCaptcha()}},onEnterOtp:function(){this.onSubmit()},numberVisible:function(){if(this.emailCount>=2){this.getView().getModel("local").setProperty("/numberVisible",true);this.getView().getModel("local").setProperty("/messageStripVisible",true)}else{this.getView().getModel("local").setProperty("/numberVisible",false);this.getView().getModel("local").setProperty("/messageStripVisible",false)}},OtpSend:function(){this.emailCount+=1;this.getView().getModel("local").setProperty("/otpVisible",true);var e=this;var t=(new Date).getTime()+1e4;var r=setInterval(function(){var o=(new Date).getTime();var l=t-o;var i=Math.floor(l%(1e3*60*60)/(1e3*60));var a=Math.floor(l%(1e3*60)/1e3);var s="Resend OTP in "+a+"s";e.getView().getModel("local").setProperty("/timerText",s);e.getView().getModel("local").setProperty("/verifySubmit",true);if(l<0){clearInterval(r);e.getView().getModel("local").setProperty("/timerText","Resend");e.getView().getModel("local").setProperty("/onResendOTP",true);e.getView().getModel("local").setProperty("/ResendMsg","If OTP not Received ")}},1e3)},OtpReSend:function(){this.emailCount+=1;this.getView().getModel("local").setProperty("/otpVisible",true);var e=this;var t=(new Date).getTime()+1e4;var r=setInterval(function(){var o=(new Date).getTime();var l=t-o;var i=Math.floor(l%(1e3*60*60)/(1e3*60));var a=Math.floor(l%(1e3*60)/1e3);var s="Resend OTP in "+a+"s";e.getView().getModel("local").setProperty("/timerText",s);e.getView().getModel("local").setProperty("/verifySubmit",true);if(l<0){clearInterval(r);e.getView().getModel("local").setProperty("/timerText","Resend");e.getView().getModel("local").setProperty("/onResendOTP",true);e.getView().getModel("local").setProperty("/ResendMsg","If OTP not Received ");e.getView().getModel("local").setProperty("/emailVisible",false);e.getView().getModel("local").setProperty("/captcha","");e.getView().getModel("local").setProperty("/numberVisible",true);e.getView().getModel("local").setProperty("/messageStripVisible",true);e.getView().getModel("local").setProperty("/otpVisible",false);e.getView().getModel("local").setProperty("/Email","")}},1e3)},onRefresh:function(e){var t=this.getView().byId("idLead");t.removeAllItems();this.onCaptchaGenerate()}})});